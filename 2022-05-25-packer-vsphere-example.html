<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 8.1.1">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"github","dark":"github"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"}},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Šä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚ é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„">
<meta property="og:type" content="blog">
<meta property="og:title" content="ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘">
<meta property="og:url" content="https://blog.k8s.li/2022-05-25-packer-vsphere-example.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Šä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚ é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png">
<meta property="article:published_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="argo-workflow">
<meta property="article:tag" content="esxi">
<meta property="article:tag" content="k3s">
<meta property="article:tag" content="packer">
<meta property="article:tag" content="redfish">
<meta property="article:tag" content="vSphere">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">


<link rel="canonical" href="https://blog.k8s.li/2022-05-25-packer-vsphere-example.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/2022-05-25-packer-vsphere-example.html","path":"2022-05-25-packer-vsphere-example.html","title":"ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘ | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="section" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="section" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9D%E9%80%80%E4%B8%89%E8%BF%9E-%F0%9F%98%82"><span class="nav-number">1.</span> <span class="nav-text">åŠé€€ä¸‰è¿ ğŸ˜‚</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Packer"><span class="nav-number">2.</span> <span class="nav-text">Packer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">å®‰è£…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-processors"><span class="nav-number">2.4.</span> <span class="nav-text">post-processors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">2.5.</span> <span class="nav-text">æ„å»º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">æ„å»ºæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-iso-%E6%9E%84%E5%BB%BA-Base-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">3.1.</span> <span class="nav-text">é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-clone-%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E5%AF%BC%E5%87%BA-OVF-OVA"><span class="nav-number">3.2.</span> <span class="nav-text">é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#argo-workflow-%E5%92%8C-k3s"><span class="nav-number">4.</span> <span class="nav-text">argo-workflow å’Œ k3s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#argo-workflow"><span class="nav-number">4.1.</span> <span class="nav-text">argo-workflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-and-k3s"><span class="nav-number">4.2.</span> <span class="nav-text">k8s and k3s</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text">å…¶ä»–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%84%9F%E5%8F%97"><span class="nav-number">5.1.</span> <span class="nav-text">ä½¿ç”¨æ„Ÿå—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OVA-%E6%A0%BC%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">OVA æ ¼å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-open-vm-tool-%E5%A4%B1%E8%B4%A5"><span class="nav-number">5.3.</span> <span class="nav-text">å®‰è£… open-vm-tool å¤±è´¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E5%AF%BC%E5%87%BA%E5%90%8E-vmdk-%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="nav-number">5.4.</span> <span class="nav-text">å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Photon3"><span class="nav-number">5.5.</span> <span class="nav-text">Photon3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#goss"><span class="nav-number">5.6.</span> <span class="nav-text">goss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5-OVA-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%8E-Pod-%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8"><span class="nav-number">5.7.</span> <span class="nav-text">å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Packer-%E7%9B%B8%E5%85%B3"><span class="nav-number">6.1.</span> <span class="nav-text">Packer ç›¸å…³</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/2022-05-25-packer-vsphere-example.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘ | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-25 2022-05-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-05-25T00:00:00+08:00">2022-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2022-05-25-packer-vsphere-example.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022-05-25-packer-vsphere-example.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/redfish-esxi-os-installer.html">ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS</a>ã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚</p>
<p>é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„å°´å°¬éš¾é¢˜ã€‚è™½ç„¶å¯ä»¥ç»™å…¶ä¸­çš„ä¸€å°ç‰©ç†æœåŠ¡å™¨å®‰è£…ä¸Šä¸€ä¸ª Linux å‘è¡Œç‰ˆæ¯”å¦‚ CentOSï¼Œç„¶åå†å°†è¿™å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„å·¥å…·æ­å»ºä¸Šå»ï¼Œä½†è¿™ä¼šé¢å¤–å ç”¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œå®¢æˆ·ä¹Ÿè‚¯å®šä¸æ„¿æ„æ¥å—ã€‚</p>
<p>çœŸå®çš„å®æ–½åœºæ™¯ä¸­ï¼Œå¯è¡Œçš„æ–¹æ¡ˆå°±æ˜¯å°†è¿™å¥—å·¥å…·è¿è¡Œåœ¨å®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºä¸Šã€‚è¿™åˆå¼•ç”³å‡ºäº†ä¸€ä¸ªå¦å¤–çš„éš¾é¢˜ï¼šå®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºè¿è¡Œçš„å¤§éƒ½æ˜¯ Windows ç³»ç»Ÿï¼Œåœ¨ Windows ä¸Šå®‰è£… Ansibleã€Makeã€Python3 ç­‰ä¸€å †ä¾èµ–ï¼Œæƒ³æƒ³å°±ä¸å¤ªç°å®ï¼Œè€Œä¸”ç¨³å®šæ€§å’Œå…¼å®¹æ€§å¾ˆéš¾å¾—åˆ°ä¿éšœï¼Œä»¥åŠå¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´å¯¼è‡´ä¸€äº›å…¶ä»–çš„å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚è™½ç„¶è¯¥å·¥å…·æ”¯æŒå®¹å™¨åŒ–è¿è¡Œèƒ½å¤Ÿè§£å†³å¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä½†åœ¨ Windows ä¸Šå®‰è£… docker ä¹Ÿæ¯”è¾ƒç¹çå’Œéº»çƒ¦ã€‚</p>
<p>è¿™æ—¶å€™å°±è¦æ¬å‡ºè®¡ç®—æœºç§‘å­¦ä¸­çš„è‡³ç†åè¨€: <strong>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³</strong>ã€‚</p>
<blockquote>
<p><strong>Any problem in computer science can be solved by another layer of indirection.</strong></p>
</blockquote>
<p>æ—¢ç„¶æˆ‘ä»¬è¿™å¥—å·¥å…·ç›®å‰åªèƒ½åœ¨ Linux ä¸Šç¨³å®šè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¦‚å°±å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€è¿è¡Œçš„ç¯å¢ƒå°è£…åœ¨ä¸€ä¸ªâ€œä¸­é—´å®¹å™¨â€é‡Œï¼Œæ¯”å¦‚è™šæ‹Ÿæœºã€‚ä½¿ç”¨è€…åªéœ€è¦å®‰è£…åƒ <a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> è™šæ‹ŸåŒ–ç®¡ç†è½¯ä»¶è¿è¡Œè¿™å°è™šæ‹Ÿæœºä¸å°±è¡Œäº†ã€‚ä¸€åˆ‡çš†å¯å¥—å¨ƒï¼ˆğŸ¤£</p>
<p>å…¶å®åŸç†å°±åƒ docker å®¹å™¨é‚£æ ·ï¼Œæˆ‘ä»¬å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€ä¾èµ–çš„è¿è¡Œç¯å¢ƒåœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å°†å®ƒä»¬å…¨éƒ¨æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä½¿ç”¨è€…åªéœ€è¦æƒ³åŠæ³•å°†è¿™ä¸ªè™šæ‹Ÿæœºè¿è¡Œèµ·æ¥ï¼Œå°±èƒ½ä¸€é”®ä½¿ç”¨æˆ‘ä»¬è¿™ä¸ªå·¥å…·ï¼Œä¸å¿…å†æ‰‹åŠ¨å®‰è£… Ansible å’Œ Python3 ç­‰ä¸€å †ä¾èµ–äº†ï¼ŒçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ã€‚</p>
<p>äºæ˜¯æœ¬æ–‡åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://www.packer.io/">Packer</a> åœ¨ <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> ç¯å¢ƒä¸Šæ„å»ºè™šæ‹Ÿæœºé•œåƒçš„æ–¹æ¡ˆï¼Œä»¥åŠå¦‚ä½•åœ¨è¿™ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œä¸€ä¸ª k3s é›†ç¾¤ï¼Œç„¶åé€šè¿‡ <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-workflows">argo-workflow</a> å·¥ä½œæµå¼•æ“è¿è¡Œ <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> æ¥å¯¹è£¸é‡‘å±æœåŠ¡å™¨è¿›è¡Œè‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„æ“ä½œã€‚</p>
<h2 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h2><ul>
<li>æå‰ä¸‹è½½å¥½ Base OS çš„ ISO é•œåƒï¼Œæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a></li>
<li>éœ€è¦ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> ä»¥åŠä¸€å° <a target="_blank" rel="noopener" href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a> ä¸»æœº</li>
<li>ESXi çš„ VM Network ç½‘ç»œä¸­éœ€è¦æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™ VM åˆ†é… IP</li>
</ul>
<h2 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h2><p>å¾ˆæ—©ä¹‹å‰ç©å„¿ VMware ESXi çš„æ—¶å€™è¿˜æ²¡æœ‰æ¥è§¦åˆ° Packerï¼Œé‚£æ—¶å€™åªèƒ½ä½¿ç”¨<a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡ç‰ˆ</a>çš„æ–¹å¼ï¼Œè´¹æ—¶è´¹åŠ›è¿˜å®¹æ˜“å‡ºé”™ï¼Œä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹è¿™ä¸ªè‡ªåŠ¨åŒ–æ„å»ºè™šæ‹Ÿæœºé•œåƒçš„å·¥å…·ã€‚</p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer">Packer</a> æ˜¯ <a target="_blank" rel="noopener" href="https://www.hashicorp.com/">hashicorp</a> å…¬å¸å¼€æºçš„ä¸€ä¸ªè™šæ‹Ÿæœºé•œåƒæ„å»ºå·¥å…·ï¼Œä¸å®ƒç±»ä¼¼çš„å·¥å…·è¿˜æœ‰ <a target="_blank" rel="noopener" href="https://github.com/openstack/diskimage-builder">OpenStack diskimage-builder</a>ã€<a target="_blank" rel="noopener" href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a> ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªåªæ”¯æŒè‡ªå®¶çš„å¹³å°ã€‚Packer èƒ½å¤Ÿæ”¯æŒä¸»æµçš„å…¬æœ‰äº‘ã€ç§æœ‰äº‘ä»¥åŠæ··åˆäº‘ï¼Œæ¯”å®ƒä¿©é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ã€‚å¯ä»¥è¿™ä¹ˆæ¥ç†è§£ï¼šPacker åœ¨ IaaS è™šæ‹ŸåŒ–é¢†åŸŸçš„åœ°ä½å°±åƒ Docker åœ¨ PaaS å®¹å™¨è™šæ‹Ÿä¸­é‚£æ ·é‡è¦ï¼Œä¸€ä¸ªæ˜¯è™šæ‹Ÿæœºé•œåƒçš„æ„å»ºï¼Œå¦ä¸€ä¸ªå®¹å™¨é•œåƒçš„æ„å»ºï¼Œæœ‰è¶£çš„æ˜¯ä¸¤è€…éƒ½æ˜¯åœ¨ 2013 å¹´æˆç«‹çš„é¡¹ç›®ã€‚</p>
<p>Kubernetes ç¤¾åŒºçš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> é¡¹ç›®å°±æ˜¯ä½¿ç”¨ Packer æ„å»ºä¸€äº›å…¬æœ‰äº‘åŠç§æœ‰äº‘çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆæä¾›ç»™ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›®ä½¿ç”¨ï¼Œååˆ†æ¨èå¤§å®¶å»çœ‹ä¸‹è¿™ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œåˆšå¼€å§‹æˆ‘ä¹Ÿæ˜¯ä»è¿™ä¸ªé¡¹ç›®ç†Ÿæ‚‰ Packer çš„ï¼Œå¹¶ä»ä¸­æŠ„è¢­å€Ÿé‰´äº†å¾ˆå¤šå†…å®¹ ğŸ˜…ã€‚</p>
<p>ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹ Packer çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</p>
<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å¯¹äº Linux å‘è¡Œç‰ˆï¼Œå»ºè®®ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…æ¥å®‰è£…ï¼Œé€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…æ„Ÿè§‰æœ‰ç‚¹éº»çƒ¦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip</span><br><span class="line">$ unzip packer_1.8.0_linux_amd64.zip</span><br><span class="line">$ <span class="built_in">mv</span> packer /usr/local/bin/packer</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯ macOS ç”¨æˆ·ç›´æ¥ <code>brew install packer</code> å‘½ä»¤ä¸€æŠŠæ¢­å°±èƒ½å®‰è£…å¥½</p>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¸åŒäº Docker æœ‰ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥å®šä¹‰å¦‚ä½•æ„å»ºå®¹å™¨é•œåƒï¼ŒPacker æ„å»ºè™šæ‹Ÿæœºé•œåƒåˆ™æ˜¯ç”±ä¸€ç³»åˆ—çš„é…ç½®æ–‡ä»¶ç¼åˆè€Œæˆï¼Œä¸»è¦ç”± <a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#builders">Builders</a> ã€<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a> ã€<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a> è¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚å…¶ä¸­ Builder ä¸»è¦æ˜¯ä¸ IaaS Provider æ„å»ºå™¨ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼›Provisioner ç”¨æ¥é…ç½®æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦è¿è¡Œçš„ä¸€äº›ä»»åŠ¡ï¼›Post-processors ç”¨äºé…ç½®æ„å»ºåŠ¨ä½œå®Œæˆåçš„ä¸€äº›åå¤„ç†æ“ä½œï¼›ä¸‹é¢å°±ä¾æ¬¡ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªé…ç½®çš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼š</p>
<p>å¦å¤– Packer æ¨èçš„é…ç½®è¯­æ³•æ˜¯ <a target="_blank" rel="noopener" href="https://www.packer.io/guides/hcl">HCL2</a>ï¼Œä½†ä¸ªäººè§‰ç€ HCL çš„è¯­æ³•é£æ ¼æ€ªæ€ªçš„ï¼Œä¸å¦‚ json é‚£æ ·æ•´æ´å¥½çœ‹ ğŸ˜…ï¼Œå› æ­¤ä¸‹é¢æˆ‘ç»Ÿä¸€ä½¿ç”¨ json æ¥è¿›è¡Œé…ç½®ï¼Œå…¶å®å‚æ•°éƒ½ä¸€æ ·ï¼Œåªæ˜¯æ ¼å¼ä¸ç›¸åŒè€Œå·²ã€‚</p>
<h4 id="vars-var-file"><a href="#vars-var-file" class="headerlink" title="vars&#x2F;var-file"></a>vars&#x2F;var-file</h4><p>Packer çš„å˜é‡é…ç½®æ–‡ä»¶æœ‰ç‚¹ç±»ä¼¼äº Ansible ä¸­çš„ varsã€‚ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ–¹å¼å°±æ˜¯æŒ‰ç…§æ¯ä¸ªå‚æ•°çš„ä½œç”¨åŸŸè¿›è¡Œåˆ†ç±»æ•´ç†ï¼Œå°†å®ƒä»¬ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç»´æŠ¤èµ·æ¥ä¼šæ›´æ–¹ä¾¿ä¸€äº›ã€‚å‚è€ƒäº† image-builder é¡¹ç›®ä¸­çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> æ„å»ºåæˆ‘æ ¹æ®å‚æ•°çš„ä¸åŒä½œç”¨åˆ’åˆ†æˆäº†å¦‚ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›ä¸ vCenter ç›¸å…³çš„å‚æ•°ï¼Œæ¯”å¦‚ datastoreã€datacenterã€resource_poolã€vcenter_server ç­‰ï¼›å¦å¤–åƒ vcenter çš„ç”¨æˆ·åå’Œå¯†ç å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œé¿å…æ˜æ–‡ç¼–ç åœ¨æ–‡ä»¶å½“ä¸­ï¼›</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;folder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Packer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;resource_pool&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Packer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Packer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Packer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Packer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;convert_to_template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;create_snapshot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;linked_clone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VM Network&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;password&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;administrator@vsphere.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vcenter_server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vcenter.k8s.li&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure_connection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… CentOS çš„å‚æ•°ï¼Œæ¯”å¦‚ ISO çš„ä¸‹è½½åœ°å€ã€ISO çš„ checksumã€kickstart æ–‡ä»¶è·¯å¾„ã€å…³æœºå‘½ä»¤ã€isolinux å¯åŠ¨å‚æ•°ç­‰ï¼›</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;boot_command_prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;tab&gt; text ks=hd:fd0:&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boot_command_suffix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/7/ks.cfg&lt;enter&gt;&lt;wait&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boot_media_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/HTTP&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;centos-7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_arch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;centos&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;floppy_dirs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;centos7-64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_checksum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_checksum_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://mirrors.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;os_display_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CentOS 7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shutdown_command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shutdown -h now&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vsphere_guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;centos7_64Guest&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… Photon3 OS çš„å‚æ•°ï¼Œå’Œä¸Šé¢çš„ centos7.json ä½œç”¨åŸºæœ¬ä¸€è‡´ï¼›</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;boot_command_prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;esc&gt;&lt;wait&gt; vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks=&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boot_command_suffix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/3/ks.json&lt;enter&gt;&lt;wait&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boot_media_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://&#123;&#123; .HTTPIP &#125;&#125;:&#123;&#123; .HTTPPort &#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;photon-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_arch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;photon&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;distro_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmware-photon-64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;http_directory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_checksum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c2883a42e402a2330d9c39b4d1e071cf9b3b5898&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_checksum_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iso_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;os_display_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VMware Photon OS 64-bit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shutdown_command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shutdown now&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vsphere_guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmwarePhoton64Guest&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>ï¼šä¸€äº›å…¬å…±å‚æ•°ï¼Œæ¯”å¦‚è™šæ‹Ÿæœºçš„ ssh ç”¨æˆ·åå’Œå¯†ç ï¼ˆè¦å’Œ kickstart ä¸­è®¾ç½®çš„ä¿æŒä¸€è‡´ï¼‰ã€è™šæ‹Ÿæœºçš„ä¸€äº›ç¡¬ä»¶é…ç½®å¦‚ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€è™šæ‹Ÿæœºç‰ˆæœ¬ã€ç½‘å¡ç±»å‹ã€å­˜å‚¨æ§åˆ¶å™¨ç±»å‹ç­‰ï¼›</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ssh_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ssh_password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;password&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boot_wait&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;disk_controller_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lsilogic&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;disk_thin_provisioned&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;disk_type_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;firmware&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bios&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cpu_cores&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4096&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;disk_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;65536&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;network_card&quot;</span><span class="punctuation">:</span> <span class="string">&quot;e1000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ssh_timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3m&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vmx_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;14&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;base_build_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `template`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build_timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;timestamp&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k3s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `ova_name`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;export_manifest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;output_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./output/&#123;&#123;user `build_version`&#125;&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h4><p>Builder å°±æ˜¯å‘Šè¯‰ Packer è¦ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„æ„å»ºå™¨æ„å»ºä»€ä¹ˆæ ·çš„è™šæ‹Ÿæœºé•œåƒï¼Œä¸»è¦æ˜¯ä¸åº•å±‚ IaaS èµ„æºæä¾›å•†ç›¸å…³çš„é…ç½®ã€‚æ¯”å¦‚ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> ä¸­æœ‰å¦‚ä¸‹ä¸¤ç§æ„å»ºå™¨ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ä» ISO å®‰è£… OS å¼€å§‹æ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºä¸ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> é€šè¿‡ clone è™šæ‹Ÿæœºçš„æ–¹å¼è¿›è¡Œæ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºäº§ç‰©ä¸ºå¯¼å‡ºåçš„ OVF&#x2F;OVA æ–‡ä»¶</li>
</ul>
<p>ä¸åŒç±»å‹çš„ Builder é…ç½®å‚æ•°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæ¯ä¸ªå‚æ•°çš„è¯¦ç»†ç”¨é€”å’Œè¯´æ˜å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins">Packer å®˜æ–¹çš„æ–‡æ¡£</a>ï¼Œåœ¨è¿™é‡Œå°±ä¸ä¸€ä¸€è¯´æ˜äº†ã€‚å› ä¸º Packer çš„å‚æ•°é…ç½®æ˜¯åœ¨æ˜¯å¤ªå¤šå¤ªå¤æ‚äº†ï¼Œå¾ˆéš¾ä¸‰è¨€ä¸¤è¯­è®²æ¸…æ¥šã€‚æœ€ä½³çš„æ–¹å¼å°±æ˜¯é˜…è¯»å®˜æ–¹çš„æ–‡æ¡£å’Œä¸€äº›å…¶ä»–é¡¹ç›®çš„å®ç°æ–¹å¼ï¼Œç…§è‘«èŠ¦ç”»ç“¢å­¦å°±è¡Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>ï¼šé‡Œé¢çš„é…ç½®å‚æ•°å¤§å¤šéƒ½æ˜¯å¼•ç”¨çš„ var-file ä¸­çš„å‚æ•°ï¼Œå°†è¿™äº›å‚æ•°å•ç‹¬æŠ½å‡ºæ¥çš„å¥½å¤„å°±æ˜¯ä¸åŒçš„ builder ä¹‹é—´å¯ä»¥å¤ç”¨ä¸€äº›å…¬å…±å‚æ•°ã€‚æ¯”å¦‚ vsphere-iso å’Œ vsphere-clone è¿™ä¸¤ç§ä¸åŒçš„ builder ä¸ vCenter ç›¸å…³çš„ datacenterã€datastoreã€vcenter_server ç­‰å‚æ•°éƒ½æ˜¯å…¶å®ç›¸åŒçš„ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ï¼šé€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;builders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;CPUs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cpu`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;RAM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `memory`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boot_command&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;&#123;&#123;user `boot_command_prefix`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;&#123;&#123;user `boot_media_path`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;&#123;&#123;user `boot_command_suffix`&#125;&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boot_wait&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `boot_wait`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cluster`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;communicator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;convert_to_template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `convert_to_template`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cpu_cores&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cpu_cores`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;create_snapshot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `create_snapshot`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `datacenter`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `datastore`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;disk_controller_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `disk_controller_type`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;firmware&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `firmware`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;floppy_dirs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `floppy_dirs`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;folder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `folder`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `host`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;http_directory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `http_directory`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;insecure_connection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `insecure_connection`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;iso_checksum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `iso_checksum_type`&#125;&#125;:&#123;&#123;user `iso_checksum`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;iso_urls&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `iso_url`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsphere-iso-base&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;network_adapters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `network`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;network_card&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `network_card`&#125;&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `password`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shutdown_command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo &#x27;&#123;&#123;user `ssh_password`&#125;&#125;&#x27; | sudo -S -E sh -c &#x27;&#123;&#123;user `shutdown_command`&#125;&#125;&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_clear_authorized_keys&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `ssh_password`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `ssh_username`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;storage&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;disk_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `disk_size`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;disk_thin_provisioned&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `disk_thin_provisioned`&#125;&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsphere-iso&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `username`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vcenter_server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `vcenter_server`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vm_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `base_build_version`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vm_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `vmx_version`&#125;&#125;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>ï¼šé€šè¿‡ clone è™šæ‹Ÿæœºæ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶å¯¼å‡ºè™šæ‹Ÿæœº OVF æ¨¡ç‰ˆ</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;builders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;CPUs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cpu`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;RAM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `memory`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cluster`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;communicator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;convert_to_template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `convert_to_template`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cpu_cores&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cpu_cores`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;create_snapshot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `create_snapshot`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `datacenter`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `datastore`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;export&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;force&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;manifest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `export_manifest`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;output_directory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `output_dir`&#125;&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;folder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `folder`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `host`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;insecure_connection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `insecure_connection`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linked_clone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `linked_clone`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsphere-clone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `network`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `password`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shutdown_command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo &#x27;&#123;&#123;user `ssh_password`&#125;&#125;&#x27; | sudo -S -E sh -c &#x27;&#123;&#123;user `shutdown_command`&#125;&#125;&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `ssh_password`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ssh_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `ssh_username`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `template`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsphere-clone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `username`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vcenter_server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `vcenter_server`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vm_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `build_version`&#125;&#125;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a><a target="_blank" rel="noopener" href="https://www.packer.io/docs/provisioners">Provisioner</a></h4><p>Provisioner å°±æ˜¯å‘Šè¯‰ Packer è¦å¦‚ä½•æ„å»ºé•œåƒï¼Œæœ‰ç‚¹ç±»ä¼¼äº Dockerile ä¸­çš„ RUN&#x2F;COPY&#x2F;ADD ç­‰æŒ‡ä»¤ï¼Œç”¨äºæ‰§è¡Œä¸€äº›å‘½ä»¤&#x2F;è„šæœ¬ã€å¾€è™šæ‹Ÿæœºé‡Œæ·»åŠ ä¸€äº›æ–‡ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æ’ä»¶æ‰§è¡Œä¸€äº›æ“ä½œç­‰ã€‚</p>
<p>åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­æˆ‘å…ˆä½¿ç”¨ file æ¨¡å—å°†ä¸€äº›è„šæœ¬å’Œä¾èµ–æ–‡ä»¶ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­ï¼Œç„¶åä½¿ç”¨ shell æ¨¡å—åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œ install.sh å®‰è£…è„šæœ¬ã€‚å¦‚æœæ„å»ºçš„ builder æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚éœ€è¦æ”¯æŒå¤šä¸ª Linux å‘è¡Œç‰ˆï¼Œè¿™ç§åœºæ™¯å»ºè®®ä½¿ç”¨ Ansibleã€‚ç”±äºæˆ‘åœ¨ ISO å®‰è£… OS çš„æ„å»ºæµç¨‹ä¸­å·²ç»å°†ä¸€äº›ä¸ OS å‘è¡Œç‰ˆç›¸å…³çš„æ“ä½œå®Œæˆäº†ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ shell æ‰§è¡Œçš„æ“ä½œä¸éœ€è¦åŒºåˆ†å“ªä¸ª Linux å‘è¡Œç‰ˆï¼Œæ‰€ä»¥å°±æ²¡æœ‰ä½¿ç”¨ ansibleã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;provisioners&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scripts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/root&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;except&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;vsphere-iso-base&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;resources&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/root&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;except&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;vsphere-iso-base&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;environment_vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;INSECURE_REGISTRY=&#123;&#123;user `insecure_registry`&#125;&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bash /root/scripts/install.sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;except&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;vsphere-iso-base&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="post-processors"><a href="#post-processors" class="headerlink" title="post-processors"></a>post-processors</h3><p>ä¸€äº›æ„å»ºåçš„æ“ä½œï¼Œ æ¯”å¦‚ <code>&quot;type&quot;: &quot;manifest&quot;</code> å¯ä»¥å¯¼å‡ºä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„é…ç½®å‚æ•°ï¼Œç»™åç»­çš„å…¶ä»–æ“ä½œæ¥ä½¿ç”¨ã€‚å†æ¯”å¦‚ <code>&quot;type&quot;: &quot;shell-local&quot;</code> å°±æ˜¯æ‰§è¡Œä¸€äº› shell è„šæœ¬ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æ‰§è¡Œä¸€ä¸ª Python è„šæœ¬å°† OVF è½¬æ¢æˆ OVAã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;post-processors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;custom_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;release_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `release_version`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;isotime&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `build_name`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `build_timestamp`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `cpu`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `memory`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;disk_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `disk_size`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distro_arch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `distro_arch` &#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distro_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `distro_name` &#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distro_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; user `distro_version` &#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;firmware&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `firmware`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `guest_os_type`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `os_display_name`&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vsphere_guest_os_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;packer-manifest&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;output&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;user `output_dir`&#125;&#125;/packer-manifest.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;strip_path&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;manifest&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;except&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;vsphere-iso-base&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;inline&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;python3 ./scripts/ova.py --vmx &#123;&#123;user `vmx_version`&#125;&#125; --ovf_template &#123;&#123;user `ovf_template`&#125;&#125; --build_dir=&#123;&#123;user `output_dir`&#125;&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;except&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;vsphere-iso-base&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsphere&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell-local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">../packer-vsphere-example</span><br><span class="line">â”œâ”€â”€ kickstart        <span class="comment"># kickstart é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ Makefile         <span class="comment"># makefileï¼Œmake å‘½ä»¤çš„æ“ä½œçš„å…¥å£</span></span><br><span class="line">â”œâ”€â”€ packer           <span class="comment"># packer é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ builder.json <span class="comment"># packer builder é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ centos7.json <span class="comment"># centos iso å®‰è£… os çš„é…ç½®</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ common.json  <span class="comment"># ä¸€äº›å…¬å…±é…ç½®å‚æ•°</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ photon3.json <span class="comment"># photon3 iso å®‰è£… os çš„é…ç½®</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ vcenter.json <span class="comment"># vcenter ç›¸å…³çš„é…ç½®</span></span><br><span class="line">â”œâ”€â”€ resources        <span class="comment"># ä¸€äº› k8s manifests æ–‡ä»¶</span></span><br><span class="line">â””â”€â”€ scripts          <span class="comment"># æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„è„šæœ¬æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<p>ä¸ docker ç±»ä¼¼ï¼Œpacker æ‰§è¡Œæ„å»ºæ“ä½œçš„å­å‘½ä»¤åŒæ ·ä¹Ÿæ˜¯ buildï¼Œå³ <code>packer build</code>ï¼Œä¸è¿‡ packer build å‘½ä»¤æ”¯æŒçš„é€‰é¡¹å¹¶æ²¡æœ‰ docker é‚£ä¹ˆä¸°å¯Œã€‚æœ€æ ¸å¿ƒé€‰é¡¹å°±æ˜¯ -except, -only, -var,  -var-file è¿™å‡ ä¸ªï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ packer build</span><br><span class="line">Options:</span><br><span class="line"></span><br><span class="line">	<span class="comment"># æ§åˆ¶ç»ˆç«¯é¢œè‰²è¾“å‡º</span></span><br><span class="line">  -color=<span class="literal">false</span>                  Disable color output. (Default: color)</span><br><span class="line">  <span class="comment"># debug æ¨¡å¼ï¼Œç±»ä¼¼äºæ–­ç‚¹çš„æ–¹å¼è¿è¡Œ</span></span><br><span class="line">  -debug                        Debug mode enabled <span class="keyword">for</span> builds.</span><br><span class="line">  <span class="comment"># æ’é™¤ä¸€äº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --skip-tags</span></span><br><span class="line">  -except=foo,bar,baz           Run all builds and post-processors other than these.</span><br><span class="line">  <span class="comment"># æŒ‡å®šè¿è¡ŒæŸäº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --tags</span></span><br><span class="line">  -only=foo,bar,baz             Build only the specified builds.</span><br><span class="line">  <span class="comment"># å¼ºåˆ¶æ„å»ºï¼Œå¦‚æœæ„å»ºç›®æ ‡å·²ç»å­˜åœ¨åˆ™å¼ºåˆ¶åˆ é™¤é‡æ–°æ„å»º</span></span><br><span class="line">  -force                        Force a build to <span class="built_in">continue</span> <span class="keyword">if</span> artifacts exist, deletes existing artifacts.</span><br><span class="line">  -machine-readable             Produce machine-readable output.</span><br><span class="line">  <span class="comment"># å‡ºç°é”™è¯¯ä¹‹åçš„åŠ¨ä½œï¼Œcleanup æ¸…ç†æ‰€æœ‰æ“ä½œã€abort ä¸­æ–­æ‰§è¡Œã€ask è¯¢é—®ã€</span></span><br><span class="line">  -on-error=[cleanup|abort|ask|run-cleanup-provisioner] If the build fails <span class="keyword">do</span>: clean up (default), abort, ask, or run-cleanup-provisioner.</span><br><span class="line">  <span class="comment"># å¹¶è¡Œè¿è¡Œçš„ builder æ•°é‡ï¼Œé»˜è®¤æ²¡æœ‰é™åˆ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible ä¸­çš„ --forks å‚æ•°</span></span><br><span class="line">  -parallel-builds=1            Number of builds to run <span class="keyword">in</span> parallel. 1 disables parallelization. 0 means no <span class="built_in">limit</span> (Default: 0)</span><br><span class="line">  <span class="comment"># UI è¾“å‡ºçš„æ—¶é—´æˆ³</span></span><br><span class="line">  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.</span><br><span class="line">  <span class="comment"># å˜é‡å‚æ•°ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e é€‰é¡¹</span></span><br><span class="line">  -var <span class="string">&#x27;key=value&#x27;</span>              Variable <span class="keyword">for</span> templates, can be used multiple <span class="built_in">times</span>.</span><br><span class="line">  <span class="comment"># å˜é‡æ–‡ä»¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e@ é€‰é¡¹</span></span><br><span class="line">  -var-file=path                JSON or HCL2 file containing user variables.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šä¸€äº› var å‚æ•°ä»¥åŠ var-file æ–‡ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ builder çš„é…ç½®æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">$ packer build  --var ova_name=k3s-photon3-c4ca93f --var release_version=c4ca93f --var ovf_template=/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml --var template=base-os-photon3 --var username=<span class="variable">$&#123;VCENTER_USERNAME&#125;</span> --var password=<span class="variable">$&#123;VCENTER_PASSWORD&#125;</span> --var vcenter_server=<span class="variable">$&#123;VCENTER_SERVER&#125;</span> --var build_name=k3s-photon3 --var output_dir=/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f -only vsphere-clone -var-file=/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file=/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file=/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢é‚£ä¸ªåˆé•¿åˆè‡­çš„ packer build å‘½ä»¤æˆ‘ä»¬åœ¨ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a> é‡Œå°è£…ä¸€ä¸‹ï¼Œé‚£ä¹ˆå¤šçš„å‚æ•°é€‰é¡¹æ‰‹åŠ¨è¾“èµ·æ¥èƒ½æŠŠäººæ°”ç–¯ ğŸ˜‚</p>
<ul>
<li>é¦–å…ˆå®šä¹‰ä¸€äº›é»˜è®¤çš„å‚æ•°ï¼Œæ¯”å¦‚æ„å»ºç‰ˆæœ¬ã€æ„å»ºæ—¶é—´ã€base æ¨¡ç‰ˆåç§°ã€å¯¼å‡º ova æ–‡ä»¶åç§°ç­‰ç­‰ã€‚</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ensure Make is run with bash shell as some syntax below is bash-specific</span></span><br><span class="line">SHELL:=/usr/bin/env bash</span><br><span class="line"><span class="section">.DEFAULT_GOAL:=help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Full directory of where the Makefile resides</span></span><br><span class="line">ROOT_DIR := <span class="variable">$(<span class="built_in">shell</span> dirname $(<span class="built_in">realpath</span> $(<span class="built_in">firstword</span> <span class="variable">$(MAKEFILE_LIST)</span>)</span>))</span><br><span class="line"></span><br><span class="line">RELEASE_VERSION       ?= <span class="variable">$(<span class="built_in">shell</span> git describe --tags --always --dirty)</span></span><br><span class="line">RELEASE_TIME          ?= <span class="variable">$(<span class="built_in">shell</span> date -u +&#x27;%Y-%m-%dT%H:%M:%SZ&#x27;)</span></span><br><span class="line">PACKER_IMAGE          ?= hashicorp/packer:1.8</span><br><span class="line">PACKER_CONFIG_DIR     = <span class="variable">$(ROOT_DIR)</span>/packer</span><br><span class="line">PACKER_FORCE          ?= false</span><br><span class="line">PACKER_OVA_PREFIX     ?= k3s</span><br><span class="line">PACKER_BASE_OS        ?= centos7</span><br><span class="line">PACKER_OUTPUT_DIR     ?= <span class="variable">$(ROOT_DIR)</span>/output</span><br><span class="line">PACKER_TEMPLATE_NAME  ?= base-os-<span class="variable">$(PACKER_BASE_OS)</span></span><br><span class="line">OVF_TEMPLATE          ?= <span class="variable">$(ROOT_DIR)</span>/scripts/ovf_template.xml</span><br><span class="line">PACKER_OVA_NAME       ?= <span class="variable">$(PACKER_OVA_PREFIX)</span>-<span class="variable">$(PACKER_BASE_OS)</span>-<span class="variable">$(RELEASE_VERSION)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ç„¶åå®šä¹‰ vars å’Œ var-file å‚æ•°</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¯å¦ä¸ºå¼ºåˆ¶æ„å»ºï¼Œå¢åŠ  force å‚æ•°</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(PACKER_FORCE)</span>, true)</span><br><span class="line">  PACKER_FORCE_ARG = --force=true</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ vars å¯å˜å‚æ•°ï¼Œæ¯”å¦‚ vcenter ç”¨æˆ·åã€å¯†ç  ç­‰å‚æ•°</span></span><br><span class="line">PACKER_VARS = <span class="variable">$(PACKER_FORCE_ARG)</span> \            <span class="comment"># æ˜¯å¦å¼ºåˆ¶æ„å»º</span></span><br><span class="line">	--var ova_name=<span class="variable">$(PACKER_OVA_NAME)</span> \          <span class="comment"># OVA æ–‡ä»¶å</span></span><br><span class="line">	--var release_version=<span class="variable">$(RELEASE_VERSION)</span> \   <span class="comment"># å‘å¸ƒç‰ˆæœ¬</span></span><br><span class="line">	--var ovf_template=<span class="variable">$(OVF_TEMPLATE)</span> \         <span class="comment"># OVF æ¨¡ç‰ˆæ–‡ä»¶</span></span><br><span class="line">	--var template=<span class="variable">$(PACKER_TEMPLATE_NAME)</span> \     <span class="comment"># OVA çš„ base è™šæ‹Ÿæœºæ¨¡ç‰ˆåç§°</span></span><br><span class="line">	--var username=$$&#123;VCENTER_USERNAME&#125; \        <span class="comment"># vCenter ç”¨æˆ·åï¼ˆç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">	--var password=$$&#123;VCENTER_PASSWORD&#125; \        <span class="comment"># vCenter å¯†ç ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">	--var vcenter_server=$$&#123;VCENTER_SERVER&#125; \    <span class="comment"># vCenter è®¿é—®åœ°å€ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">	--var build_name=<span class="variable">$(PACKER_OVA_PREFIX)</span>-<span class="variable">$(PACKER_BASE_OS)</span> \  <span class="comment"># æ„å»ºåç§°</span></span><br><span class="line">	--var output_dir=<span class="variable">$(PACKER_OUTPUT_DIR)</span>/<span class="variable">$(PACKER_OVA_NAME)</span>   <span class="comment"># OVA å¯¼å‡ºçš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ var-file å‚æ•°</span></span><br><span class="line">PACKER_VAR_FILES = -var-file=<span class="variable">$(PACKER_CONFIG_DIR)</span>/vcenter.json \ <span class="comment"># vCenter çš„å‚æ•°é…ç½®</span></span><br><span class="line">	-var-file=<span class="variable">$(PACKER_CONFIG_DIR)</span>/<span class="variable">$(PACKER_BASE_OS)</span>.json \        <span class="comment"># OS çš„å‚æ•°é…ç½®</span></span><br><span class="line">	-var-file=<span class="variable">$(PACKER_CONFIG_DIR)</span>/common.json                     <span class="comment"># ä¸€äº›å…¬å…±é…ç½®</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æœ€åå®šä¹‰ make targrt</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: build-template</span></span><br><span class="line"><span class="comment"># é€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ª base è™šæ‹Ÿæœº</span></span><br><span class="line"><span class="section">build-template: ## build the base os template by iso</span></span><br><span class="line">	packer build <span class="variable">$(PACKER_VARS)</span> -only vsphere-iso-base <span class="variable">$(PACKER_VAR_FILES)</span> <span class="variable">$(PACKER_CONFIG_DIR)</span>/builder.json</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: build-ovf</span></span><br><span class="line"><span class="comment"># é€šè¿‡ clone æ–¹å¼æ„å»ºå¹¶å¯¼å‡º OVF/OVA</span></span><br><span class="line"><span class="section">build-ovf: ## build the ovf template by clone the base os template</span></span><br><span class="line">	packer build <span class="variable">$(PACKER_VARS)</span> -only vsphere-clone <span class="variable">$(PACKER_VAR_FILES)</span> <span class="variable">$(PACKER_CONFIG_DIR)</span>/builder.json</span><br></pre></td></tr></table></figure>

<ul>
<li>æ„å»º BASE æ¨¡ç‰ˆ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span></span><br><span class="line">$ make build-template PACKER_BASE_OS=photon3</span><br></pre></td></tr></table></figure>

<ul>
<li>æ„å»º OVF æ¨¡ç‰ˆå¹¶å¯¼å‡ºä¸º OVA</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span></span><br><span class="line">$ make build-ovf PACKER_BASE_OS=photon3</span><br></pre></td></tr></table></figure>

<h2 id="æ„å»ºæµç¨‹"><a href="#æ„å»ºæµç¨‹" class="headerlink" title="æ„å»ºæµç¨‹"></a>æ„å»ºæµç¨‹</h2><p>å°† Packer çš„é…ç½®æ–‡ä»¶ä»¥åŠ Makefile å°è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œ <code>make build-template</code> å’Œ <code>make build-ovf</code> å‘½ä»¤æ¥æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆäº†ï¼Œæ•´ä½“çš„æ„å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆä½¿ç”¨ ISO æ„å»ºä¸€ä¸ªä¸ä¸šåŠ¡æ— å…³çš„ base è™šæ‹Ÿæœº</li>
<li>åœ¨ base è™šæ‹Ÿæœºä¹‹ä¸Šé€šè¿‡ vsphere-clone æ–¹å¼æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœº</li>
<li>å¯¼å‡º OVF è™šæ‹Ÿæœºæ–‡ä»¶ï¼Œæ‰“åŒ…æˆ OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
</ul>
<h3 id="é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº"><a href="#é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº" class="headerlink" title="é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº"></a>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº</h3><p>base è™šæ‹Ÿæœºæœ‰ç‚¹ç±»ä¼¼äº Dockerfile ä¸­çš„ FROM base é•œåƒã€‚åœ¨ Packer ä¸­æˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›å¾ˆå°‘ä¼šæ”¹åŠ¨çš„å†…å®¹åšæˆä¸€ä¸ª base è™šæ‹Ÿæœºã€‚ç„¶åä»è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºæ¥å®Œæˆæ¥ä¸‹æ¥çš„æ„å»ºæµç¨‹ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœæ•´ä½“çš„æ„å»ºè€—æ—¶ï¼Œä½¿å¾—æ„å»ºæ•ˆç‡æ›´é«˜ä¸€äº›ã€‚</p>
<ul>
<li>centos7 æ„å»ºè¾“å‡ºæ—¥å¿—</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">vsphere-iso-base: output will be <span class="keyword">in</span> this color.</span><br><span class="line">==&gt; vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded; continuing</span><br><span class="line">==&gt; vsphere-iso-base: File [Packer] packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists; skipping upload.</span><br><span class="line">==&gt; vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to -force flag</span><br><span class="line">==&gt; vsphere-iso-base: Creating VM...</span><br><span class="line">==&gt; vsphere-iso-base: Customizing hardware...</span><br><span class="line">==&gt; vsphere-iso-base: Mounting ISO images...</span><br><span class="line">==&gt; vsphere-iso-base: Adding configuration parameters...</span><br><span class="line">==&gt; vsphere-iso-base: Creating floppy disk...</span><br><span class="line">    vsphere-iso-base: Copying files flatly from floppy_files</span><br><span class="line">    vsphere-iso-base: Done copying files from floppy_files</span><br><span class="line">    vsphere-iso-base: Collecting paths from floppy_dirs</span><br><span class="line">    vsphere-iso-base: Resulting paths from floppy_dirs : [./kickstart/centos/http/]</span><br><span class="line">    vsphere-iso-base: Recursively copying : ./kickstart/centos/http/</span><br><span class="line">    vsphere-iso-base: Done copying paths from floppy_dirs</span><br><span class="line">    vsphere-iso-base: Copying files from floppy_content</span><br><span class="line">    vsphere-iso-base: Done copying files from floppy_content</span><br><span class="line">==&gt; vsphere-iso-base: Uploading created floppy image</span><br><span class="line">==&gt; vsphere-iso-base: Adding generated Floppy...</span><br><span class="line">==&gt; vsphere-iso-base: Set boot order temporary...</span><br><span class="line">==&gt; vsphere-iso-base: Power on VM...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting 15s <span class="keyword">for</span> boot...</span><br><span class="line">==&gt; vsphere-iso-base: Typing boot <span class="built_in">command</span>...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting <span class="keyword">for</span> IP...</span><br><span class="line">==&gt; vsphere-iso-base: IP address: 192.168.29.46</span><br><span class="line">==&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.46</span><br><span class="line">==&gt; vsphere-iso-base: Waiting <span class="keyword">for</span> SSH to become available...</span><br><span class="line">==&gt; vsphere-iso-base: Connected to SSH!</span><br><span class="line">==&gt; vsphere-iso-base: Executing shutdown <span class="built_in">command</span>...</span><br><span class="line">==&gt; vsphere-iso-base: Deleting Floppy drives...</span><br><span class="line">==&gt; vsphere-iso-base: Deleting Floppy image...</span><br><span class="line">==&gt; vsphere-iso-base: Eject CD-ROM drives...</span><br><span class="line">==&gt; vsphere-iso-base: Creating snapshot...</span><br><span class="line">==&gt; vsphere-iso-base: Clear boot order...</span><br><span class="line">Build <span class="string">&#x27;vsphere-iso-base&#x27;</span> finished after 6 minutes 42 seconds.</span><br><span class="line">==&gt; Wait completed after 6 minutes 42 seconds</span><br><span class="line">==&gt; Builds finished. The artifacts of successful builds are:</span><br><span class="line">--&gt; vsphere-iso-base: base-os-centos7</span><br><span class="line"></span><br><span class="line">[root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d] <span class="built_in">ls</span> packer_cache/</span><br><span class="line">51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso</span><br><span class="line">[root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d] <span class="built_in">ls</span> -alh base-os-centos7/</span><br><span class="line">total 4281536</span><br><span class="line">drwxr-xr-x    1 root     root       72.0K Apr  1 09:17 .</span><br><span class="line">drwxr-xr-t    1 root     root       76.0K Apr  1 09:17 ..</span><br><span class="line">-rw-------    1 root     root        4.0G Apr  1 09:17 base-os-centos7-3ea6b205.vswp</span><br><span class="line">-rw-r--r--    1 root     root         253 Apr  1 09:17 base-os-centos7-65ff34a3.hlog</span><br><span class="line">-rw-------    1 root     root       64.0G Apr  1 09:17 base-os-centos7-flat.vmdk</span><br><span class="line">-rw-------    1 root     root        8.5K Apr  1 09:17 base-os-centos7.nvram</span><br><span class="line">-rw-------    1 root     root         482 Apr  1 09:17 base-os-centos7.vmdk</span><br><span class="line">-rw-r--r--    1 root     root           0 Apr  1 09:17 base-os-centos7.vmsd</span><br><span class="line">-rwxr-xr-x    1 root     root        2.3K Apr  1 09:17 base-os-centos7.vmx</span><br><span class="line">-rw-------    1 root     root           0 Apr  1 09:17 base-os-centos7.vmx.lck</span><br><span class="line">-rwxr-xr-x    1 root     root        2.2K Apr  1 09:17 base-os-centos7.vmx~</span><br><span class="line">-rw-------    1 root     root        1.4M Apr  1 09:17 packer-tmp-created-floppy.flp</span><br><span class="line">-rw-r--r--    1 root     root       96.1K Apr  1 09:17 vmware.log</span><br><span class="line"></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span></span><br><span class="line"></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># mount packer-tmp-created-floppy.flp /mnt</span></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># readlink /dev/disk/by-label/packer</span></span><br><span class="line">../../loop2</span><br><span class="line">root@devbox-fedora:/root <span class="comment"># ls /mnt/HTTP/7/KS.CFG</span></span><br><span class="line">KS.CFG</span><br></pre></td></tr></table></figure>

<ul>
<li>Photon3 æ„å»ºè¾“å‡ºæ—¥å¿—</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vsphere-iso-base: output will be in this color.</span><br><span class="line"></span><br><span class="line">==&gt; vsphere-iso-base: File /root/.cache/packer/d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing</span><br><span class="line">==&gt; vsphere-iso-base: File [Packer] packer_cache//d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.</span><br><span class="line">==&gt; vsphere-iso-base: the vm/template Packer/base-os-photon3 already exists, but deleting it due to -force flag</span><br><span class="line">==&gt; vsphere-iso-base: Creating VM...</span><br><span class="line">==&gt; vsphere-iso-base: Customizing hardware...</span><br><span class="line">==&gt; vsphere-iso-base: Mounting ISO images...</span><br><span class="line">==&gt; vsphere-iso-base: Adding configuration parameters...</span><br><span class="line">==&gt; vsphere-iso-base: Starting HTTP server on port 8674</span><br><span class="line">==&gt; vsphere-iso-base: Set boot order temporary...</span><br><span class="line">==&gt; vsphere-iso-base: Power on VM...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting 15s for boot...</span><br><span class="line">==&gt; vsphere-iso-base: HTTP server is working at http://192.168.29.171:8674/</span><br><span class="line">==&gt; vsphere-iso-base: Typing boot command...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting for IP...</span><br><span class="line">==&gt; vsphere-iso-base: IP address: 192.168.29.208</span><br><span class="line">==&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208</span><br><span class="line">==&gt; vsphere-iso-base: Waiting for SSH to become available...</span><br><span class="line">==&gt; vsphere-iso-base: Connected to SSH!</span><br><span class="line">==&gt; vsphere-iso-base: Executing shutdown command...</span><br><span class="line">==&gt; vsphere-iso-base: Deleting Floppy drives...</span><br><span class="line">==&gt; vsphere-iso-base: Eject CD-ROM drives...</span><br><span class="line">==&gt; vsphere-iso-base: Creating snapshot...</span><br><span class="line">==&gt; vsphere-iso-base: Clear boot order...</span><br><span class="line">Build &#x27;vsphere-iso-base&#x27; finished after 5 minutes 24 seconds.</span><br><span class="line"></span><br><span class="line">==&gt; Wait completed after 5 minutes 24 seconds</span><br><span class="line"></span><br><span class="line">==&gt; Builds finished. The artifacts of successful builds are:</span><br><span class="line">--&gt; vsphere-iso-base: base-os-photon3</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>packer build</code> å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºé€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºçš„ä¸»è¦æ­¥éª¤å’ŒåŸç†ï¼š</p>
<ul>
<li>ä¸‹è½½ ISO æ–‡ä»¶åˆ°æœ¬åœ°çš„ ${HOME}&#x2F;.cache&#x2F;packer ç›®å½•ï¼Œå¹¶ä»¥ checksum.iso æ–¹å¼ä¿å­˜ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ä¾¿äºç¼“å­˜ ISO æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸‹è½½ï¼›</li>
<li>ä¸Šä¼ æœ¬åœ° ISO æ–‡ä»¶åˆ° vCenter çš„ datastore ä¸­ï¼Œé»˜è®¤ä¿å­˜åœ¨ datastore çš„ packer_cache ç›®å½•ä¸‹ï¼Œå¦‚æœ ISO æ–‡ä»¶å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¼šè·³è¿‡ä¸Šä¼ çš„æµç¨‹ï¼›</li>
<li>åˆ›å»ºè™šæ‹Ÿæœºï¼Œé…ç½®è™šæ‹Ÿæœºç¡¬ä»¶ï¼ŒæŒ‚è½½ä¸Šä¼ çš„ ISO æ–‡ä»¶åˆ°è™šæ‹Ÿæœºä¸Šçš„ CD&#x2F;ROMï¼Œè®¾ç½® boot å¯åŠ¨é¡¹ä¸º CD&#x2F;ROM</li>
<li>å¦‚æœ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> æ˜¯ http ç±»å‹çš„åˆ™åœ¨æœ¬åœ°éšæœºç›‘å¬ä¸€ä¸ª TCP ç«¯å£æ¥è¿è¡Œä¸€ä¸ª http æœåŠ¡ï¼Œç”¨äºæä¾› kickstart æ–‡ä»¶çš„ HTTP ä¸‹è½½åŠŸèƒ½ï¼›å¦‚æœæ˜¯ç›®å½•ç±»å‹çš„åˆ™å°† kickstart æ–‡ä»¶åˆ›å»ºæˆä¸€ä¸ªè½¯ç›˜æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ° datastore ä¸­ï¼Œå°†è½¯ç›˜æ–‡ä»¶æ’å…¥åˆ°è™šæ‹Ÿæœºä¸­ï¼›</li>
<li>è™šæ‹Ÿæœºå¼€æœºå¯åŠ¨åˆ° ISO å¼•å¯¼é¡µé¢ï¼Œé€šè¿‡ vCenter API å‘é€é”®ç›˜è¾“å…¥ï¼Œæ’å…¥ kickstart æ–‡ä»¶çš„è·¯å¾„ï¼›</li>
<li>é€šè¿‡ vCenter API å‘é€å›è½¦é”®ç›˜è¾“å…¥ï¼ŒISO ä¸­çš„ OS å®‰è£…ç¨‹åºè¯»å– kickstart è¿›è¡Œ OS å®‰è£…ï¼›</li>
<li>åœ¨ kickstart è„šæœ¬é‡Œå®‰è£… <a target="_blank" rel="noopener" href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> å·¥å…·ï¼›</li>
<li>ç­‰å¾… OS å®‰è£…å®Œæˆï¼Œå®‰è£…å®Œæˆé‡å¯åè¿›å…¥å®‰è£…å¥½çš„ OSï¼ŒOS å¯åŠ¨åé€šè¿‡ DHCP è·å– IP åœ°å€ï¼›</li>
<li>é€šè¿‡ vm-tools è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼Œç„¶å ssh è¿æ¥åˆ°è™šæ‹Ÿæœºæ‰§è¡Œå…³æœºå‘½ä»¤ï¼›</li>
<li>è™šæ‹Ÿæœºå…³æœºï¼Œå¸è½½ ISO å’Œè½¯é©±ç­‰ä¸éœ€è¦çš„è®¾å¤‡ï¼›</li>
<li>åˆ›å»ºå¿«ç…§æˆ–è€…å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼›</li>
</ul>
<p>ä¸ªäººè§‰ç€è¿™é‡Œæ¯”è¾ƒå¥½ç©å„¿å°±æ˜¯å±…ç„¶å¯ä»¥é€šè¿‡ vCenter æˆ– ESXi çš„ <a target="_blank" rel="noopener" href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API æ¥ç»™è™šæ‹Ÿæœºå‘é€ä¸€äº›é”®ç›˜è¾“å…¥çš„æŒ‡ä»¤ï¼Œæ„Ÿè§‰è¿™ç®€ç›´å¤ªç¥å¥‡å•¦ ğŸ˜‚ã€‚ä¹‹å‰æˆ‘ä»¬çš„é¡¹ç›®æ˜¯å°† kickstart æ–‡ä»¶æ„å»ºæˆä¸€ä¸ª ISO æ–‡ä»¶ï¼Œç„¶åé€šè¿‡é‡æ–°æ„å»ºæº ISO çš„æ–¹å¼æ¥ä¿®æ”¹ isolinux å¯åŠ¨å‚æ•°ã€‚åæ¥æ„Ÿè§‰è¿™ç§é‡æ–°æ„å»º ISO çš„æ–¹å¼å¤ªè ¢äº†ï¼Œäºæ˜¯å°±å‚è€ƒ Packer çš„æ€è·¯ä½¿ç”¨ govc é‡Œå†…ç½®çš„ <a target="_blank" rel="noopener" href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> å‘½ä»¤æ¥ç»™è™šæ‹Ÿæœºå‘é€é”®ç›˜æŒ‡ä»¤ï¼Œå®ŒæˆæŒ‡å®š kickstart æ–‡ä»¶è·¯å¾„å‚æ•°å¯åŠ¨çš„æ“ä½œã€‚å…·ä½“çš„ govc æ“ä½œå‘½ä»¤å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘é€ tab é”®ï¼Œè¿›å…¥åˆ° ISO å¯åŠ¨å‚æ•°ç¼–è¾‘é¡µé¢</span></span><br><span class="line">$ govc vm.keystrokes -vm=<span class="string">&#x27;centos-vm-192&#x27;</span> -c=<span class="string">&#x27;KEY_TAB&#x27;</span></span><br><span class="line"><span class="comment"># å‘é€ Right Control + U é”®æ¸…ç©ºè¾“å…¥æ¡†</span></span><br><span class="line">$ govc vm.keystrokes -vm=<span class="string">&#x27;centos-vm-192&#x27;</span> -rc=<span class="literal">true</span> -c=<span class="string">&#x27;KEY_U&#x27;</span></span><br><span class="line"><span class="comment"># è¾“å…¥ isolinux çš„å¯åŠ¨å‚æ•°é…ç½®ï¼Œé€šè¿‡ ks=hd:LABEL=KS:/ks.cfg æŒ‡å®š kickstart è·¯å¾„ï¼ŒLABEL ä¸ºæ„å»º ISO æ—¶è®¾ç½®çš„ lable</span></span><br><span class="line">$ govc vm.keystrokes -vm=<span class="string">&#x27;centos-vm-192&#x27;</span> -s=<span class="string">&#x27;vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0&#x27;</span></span><br><span class="line"><span class="comment"># æŒ‰ä¸‹å›è½¦é”®ï¼Œå¼€å§‹å®‰è£… OS</span></span><br><span class="line">$ govc vm.keystrokes -vm=<span class="string">&#x27;centos-vm-192&#x27;</span> -c=<span class="string">&#x27;KEY_ENTER&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-OVA"><a href="#é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-OVA" class="headerlink" title="é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA"></a>é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA</h3><p>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºä¹‹åï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºï¼Œç”¨æ¥æ„å»ºæˆ‘ä»¬çš„ä¸šåŠ¡è™šæ‹Ÿæœºé•œåƒï¼Œå°† k3s, argo-workflow, redfish-esxi-os-installer è¿™ä¸€å †å·¥å…·æ‰“åŒ…è¿›å»ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vsphere-clone: output will be <span class="keyword">in</span> this color.</span><br><span class="line"></span><br><span class="line">==&gt; vsphere-clone: Cloning VM...</span><br><span class="line">==&gt; vsphere-clone: Customizing hardware...</span><br><span class="line">==&gt; vsphere-clone: Power on VM...</span><br><span class="line">==&gt; vsphere-clone: Waiting <span class="keyword">for</span> IP...</span><br><span class="line">==&gt; vsphere-clone: IP address: 192.168.30.112</span><br><span class="line">==&gt; vsphere-clone: Using SSH communicator to connect: 192.168.30.112</span><br><span class="line">==&gt; vsphere-clone: Waiting <span class="keyword">for</span> SSH to become available...</span><br><span class="line">==&gt; vsphere-clone: Connected to SSH!</span><br><span class="line">==&gt; vsphere-clone: Uploading scripts =&gt; /root</span><br><span class="line">==&gt; vsphere-clone: Uploading resources =&gt; /root</span><br><span class="line">==&gt; vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976</span><br><span class="line">==&gt; vsphere-clone: Executing shutdown <span class="built_in">command</span>...</span><br><span class="line">==&gt; vsphere-clone: Creating snapshot...</span><br><span class="line">    vsphere-clone: Starting <span class="built_in">export</span>...</span><br><span class="line">    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk</span><br><span class="line">    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk</span><br><span class="line">    vsphere-clone: Writing ovf...</span><br><span class="line">==&gt; vsphere-clone: Running post-processor: packer-manifest (<span class="built_in">type</span> manifest)</span><br><span class="line">==&gt; vsphere-clone: Running post-processor: vsphere (<span class="built_in">type</span> shell-local)</span><br><span class="line">==&gt; vsphere-clone (shell-local): Running <span class="built_in">local</span> shell script: /tmp/packer-shell2376077966</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: <span class="built_in">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: create ovf k3s-photon3-c4ca93f.ovf</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: creating OVA using tar</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: [<span class="string">&#x27;tar&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;k3s-photon3-c4ca93f.ova&#x27;</span>, <span class="string">&#x27;k3s-photon3-c4ca93f.ovf&#x27;</span>, <span class="string">&#x27;k3s-photon3-c4ca93f.mf&#x27;</span>, <span class="string">&#x27;k3s-photon3-c4ca93f-disk-0.vmdk&#x27;</span>]</span><br><span class="line">    vsphere-clone (shell-local): image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256</span><br><span class="line">Build <span class="string">&#x27;vsphere-clone&#x27;</span> finished after 14 minutes 16 seconds.</span><br><span class="line"></span><br><span class="line">==&gt; Wait completed after 14 minutes 16 seconds</span><br><span class="line"></span><br><span class="line">==&gt; Builds finished. The artifacts of successful builds are:</span><br><span class="line">--&gt; vsphere-clone: k3s-photon3-c4ca93f</span><br><span class="line">--&gt; vsphere-clone: k3s-photon3-c4ca93f</span><br><span class="line">--&gt; vsphere-clone: k3s-photon3-c4ca93f</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ packer build å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºæ„å»ºæµç¨‹ï¼š</p>
<ul>
<li>clone è™šæ‹Ÿæœºï¼Œä¿®æ”¹è™šæ‹Ÿæœºçš„ç¡¬ä»¶é…ç½®</li>
<li>è™šæ‹Ÿæœºå¼€æœºï¼Œé€šè¿‡ vm-tools è·å–è™šæ‹Ÿæœºçš„ IP åœ°å€</li>
<li>è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€åç­‰å¾… ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥</li>
<li>ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥åï¼Œé€šè¿‡ scp çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</li>
<li>ssh è¿œç¨‹æ‰§è¡Œè™šæ‹Ÿæœºé‡Œçš„ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> è„šæœ¬</li>
<li>æ‰§è¡Œè™šæ‹Ÿæœºå…³æœºå‘½ä»¤</li>
<li>åˆ›å»ºè™šæ‹Ÿæœºå¿«ç…§</li>
<li>å¯¼å‡ºè™šæ‹Ÿæœº OVF æ–‡ä»¶</li>
<li>å¯¼å‡ºæ„å»ºé…ç½®å‚æ•°çš„ manifest.json æ–‡ä»¶</li>
<li>æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> è„šæœ¬ï¼Œæ ¹æ® manifest.json é…ç½®å‚æ•°å°† OVF æ ¼å¼è½¬æ¢æˆ OVA</li>
</ul>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªçš„è™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ„å»ºæµç¨‹ç®—æ˜¯å®Œæˆäº†ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„åˆ°ä¸€ä¸ª OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆã€‚ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ VMware Workstation æˆ–è€… Oracle VirtualBox å°±èƒ½ä¸€é”®å¯¼å…¥è¯¥è™šæ‹Ÿæœºï¼Œå¼€æœºåå°±å¯ä»¥ä½¿ç”¨å•¦ï¼Œç®—æ˜¯åšåˆ°äº†å¼€ç®±å³ç”¨çš„æ•ˆæœã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output</span><br><span class="line">â””â”€â”€ k3s-photon3-c4ca93f</span><br><span class="line">    â”œâ”€â”€ k3s-photon3-c4ca93f-disk-0.vmdk</span><br><span class="line">    â”œâ”€â”€ k3s-photon3-c4ca93f.mf</span><br><span class="line">    â”œâ”€â”€ k3s-photon3-c4ca93f.ova</span><br><span class="line">    â”œâ”€â”€ k3s-photon3-c4ca93f.ova.sha256</span><br><span class="line">    â”œâ”€â”€ k3s-photon3-c4ca93f.ovf</span><br><span class="line">    â””â”€â”€ packer-manifest.json</span><br></pre></td></tr></table></figure>

<h2 id="argo-workflow-å’Œ-k3s"><a href="#argo-workflow-å’Œ-k3s" class="headerlink" title="argo-workflow å’Œ k3s"></a>argo-workflow å’Œ k3s</h2><p>åœ¨è™šæ‹Ÿæœºå†…ä½¿ç”¨ redfish-esxi-os-installer æœ‰ç‚¹ç‰¹æ®Šï¼Œæ˜¯å°†å®ƒæ”¾åœ¨ argo-workflow çš„ Pod å†…æ¥æ‰§è¡Œçš„ã€‚åœ¨ workflow æ¨¡ç‰ˆæ–‡ä»¶ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> ä¸­æˆ‘ä»¬å®šä¹‰äº†è‹¥å¹²ä¸ª steps æ¥è¿è¡Œ redfish-esxi-os-installerã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">redfish-esxi-os-installer-</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entrypoint:</span> <span class="string">redfish-esxi-os-installer</span></span><br><span class="line">  <span class="attr">templates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redfish-esxi-os-installer</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">pre-check</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Precheck</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">build-iso</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">BuildISO</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">mount-iso</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">MountISO</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">reboot</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Reboot</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">post-check</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Postcheck</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">umount-iso</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">UmountISO</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">installer</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">container:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">installer</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        make inventory &amp;&amp; make &#123;&#123;inputs.parameters.command&#125;&#125;</span></span><br><span class="line"><span class="string"></span>      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">fieldRef:</span></span><br><span class="line">            <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">fieldRef:</span></span><br><span class="line">            <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SRC_ISO_DIR</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/data/iso</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_DIR</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/data/iso/redfish</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_URL</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">http://$(HOST_IP)/files/iso/redfish</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ESXI_ISO</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">redfish-esxi-os-installer-config</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">esxi_iso</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/ansible/config.yaml</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">subPath:</span> <span class="string">config.yaml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">installer</span></span><br><span class="line">    <span class="attr">retryStrategy:</span></span><br><span class="line">      <span class="attr">limit:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      <span class="attr">retryPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">config.yaml</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redfish-esxi-os-installer-config</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<p>ç”±äºç›®å‰æ²¡æœ‰ Web UI å’Œåç«¯ Server æ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">&#x2F;root&#x2F;resources&#x2F;workflow&#x2F;configmap.yaml</a> é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ <code>kubectl create -f /root/resources/workflow</code> å‘½ä»¤åˆ›å»º workflow å·¥ä½œæµã€‚</p>
<p>workflow åˆ›å»ºäº†ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ argo å‘½ä»¤æŸ¥çœ‹ workflow æ‰§è¡Œçš„è¿›åº¦å’ŒçŠ¶æ€</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@localhost [ ~/resources/workflow ]# argo get redfish-esxi-os-installer-tjjqz</span><br><span class="line">Name:                redfish-esxi-os-installer-tjjqz</span><br><span class="line">Namespace:           default</span><br><span class="line">ServiceAccount:      <span class="built_in">unset</span> (will run with the default ServiceAccount)</span><br><span class="line">Status:              Succeeded</span><br><span class="line">Conditions:</span><br><span class="line"> PodRunning          False</span><br><span class="line"> Completed           True</span><br><span class="line">Created:             Mon May 23 11:07:31 +0000 (16 minutes ago)</span><br><span class="line">Started:             Mon May 23 11:07:31 +0000 (16 minutes ago)</span><br><span class="line">Finished:            Mon May 23 11:23:38 +0000 (19 seconds ago)</span><br><span class="line">Duration:            16 minutes 7 seconds</span><br><span class="line">Progress:            6/6</span><br><span class="line">ResourcesDuration:   29m45s*(1 cpu),29m45s*(100Mi memory)</span><br><span class="line"></span><br><span class="line">STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE</span><br><span class="line"> âœ” redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer</span><br><span class="line"> â”œâ”€â”€â”€âœ” Precheck(0)                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s</span><br><span class="line"> â”œâ”€â”€â”€âœ” BuildISO(0)                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s</span><br><span class="line"> â”œâ”€â”€â”€âœ” MountISO(0)                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s</span><br><span class="line"> â”œâ”€â”€â”€âœ” Reboot(0)                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s</span><br><span class="line"> â”œâ”€â”€â”€âœ” Postcheck(0)                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m</span><br><span class="line"> â””â”€â”€â”€âœ” UmountISO(0)                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s</span><br></pre></td></tr></table></figure>

<h3 id="argo-workflow"><a href="#argo-workflow" class="headerlink" title="argo-workflow"></a>argo-workflow</h3><p>ä¹‹æ‰€ä»¥ä½¿ç”¨ argo-workflow è€Œä¸æ˜¯ä½¿ç”¨åƒ dockerã€nerdctl è¿™äº›å‘½ä»¤è¡Œå·¥å…·æ¥è¿è¡Œ redfish-esxi-os-installer ï¼Œæ˜¯å› ä¸ºé€šè¿‡ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å®ç°å¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è¿›åº¦åŠæ—¥å¿—ã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è€—æ—¶ã€åœæ­¢é‡è¯•ç­‰åŠŸèƒ½ã€‚ä½¿ç”¨ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡ï¼Œå¹¶é€šè¿‡ argo-workflow çš„ RESTful API è·å–éƒ¨ç½²ä»»åŠ¡çš„è¿›åº¦æ—¥å¿—ç­‰ä¿¡æ¯ï¼Œè¿™æ ·åšæ›´äº‘åŸç”Ÿä¸€äº›ï¼ˆğŸ¤£</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png" alt="argo-workfloe-apis"></p>
<p>åœ¨æˆ‘ä»¬å†…éƒ¨å…¶å®æœ€ç»ˆç›®çš„æ˜¯å‡†å¤‡å°†è¯¥æ–¹æ¡ˆåšæˆä¸€ä¸ªäº§å“åŒ–çš„å·¥å…·ï¼Œæä¾›ä¸€ä¸ª Web UI ç”¨æ¥è¿›è¡Œé…ç½®éƒ¨ç½²å‚æ•°ä»¥åŠå±•ç¤ºéƒ¨ç½²çš„è¿›åº¦æ—¥å¿—ç­‰åŠŸèƒ½ã€‚å½“åˆè®¾è®¡æ–¹æ¡ˆçš„æ—¶å€™ä¹Ÿæ˜¯å‚è€ƒäº†ä¸€ä¸‹  <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ï¼šéƒ¨ç½² Tanzu ç®¡ç†é›†ç¾¤çš„æ—¶å€™éœ€è¦æœ‰ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ k8s é›†ç¾¤ï¼Œæˆ–è€…é€šè¿‡ Tanzu æ–°éƒ¨ç½²ä¸€ä¸ª kind é›†ç¾¤ã€‚éƒ¨ç½²ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤å¯ä»¥é€šè¿‡ tanzu å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Tanzu Web UI çš„æ–¹å¼ï¼ŒTanzu Web UI çš„æ–¹å¼å…¶å®å°±æ˜¯ä¸€ä¸ªåå‘äºäº§å“åŒ–çš„å·¥å…·ã€‚åœ¨ <a href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ</a> æˆ‘æ›¾åˆ†äº«è¿‡ Tanzu çš„éƒ¨ç½²æ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png" alt="tanzu-cluster"></p>
<p>è¯¥æ–¹æ¡ˆä¸»è¦æ˜¯é¢å‘ä¸€äº›äº§å“åŒ–çš„åœºæ™¯ï¼Œç”±äºå¼•å…¥äº† K8s è¿™ä¸ªåºç„¶å¤§ç‰©ï¼Œæ•´ä½“çš„æŠ€æœ¯æ ˆä¼šå¤æ‚ä¸€äº›ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å¥½å¤„å•¦ ğŸ˜…ã€‚</p>
<h3 id="k8s-and-k3s"><a href="#k8s-and-k3s" class="headerlink" title="k8s and k3s"></a>k8s and k3s</h3><p>argo-workflow éœ€è¦ä¾èµ–ä¸€ä¸ª k8s é›†ç¾¤æ‰èƒ½è¿è¡Œï¼Œæˆ‘ä»¬å†…éƒ¨æµ‹è¯•äº† kubekeyã€sealosã€kubesprayã€k3s å‡ ç§å¸¸è§çš„éƒ¨ç½²å·¥å…·ã€‚ç»¼åˆè¯„å®šä¸‹æ¥ k3s é›†ç¾¤å ç”¨çš„èµ„æºæœ€å°‘ã€‚å‚è€ƒ <a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a> ç»™å‡ºçš„èµ„æºè¦æ±‚ï¼Œæœ€å°åªéœ€è¦ 768M å†…å­˜å°±èƒ½è¿è¡Œã€‚å¯¹äºç¡¬ä»¶èµ„æºä¸å¤ªå……è¶³çš„ç¬”è®°æœ¬ç”µè„‘æ¥è®²ï¼Œk3s æ— ç–‘æ˜¯ç›®å‰æœ€ä½³çš„æ–¹æ¡ˆã€‚</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªååˆ†é‡è¦çš„åŸå› å°±æ˜¯ k3s server æ›´æ¢å• control plan èŠ‚ç‚¹çš„ IP åœ°å€ååˆ†æ–¹ä¾¿ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ã€‚è¿™æ ·å°±å¯ä»¥å°†å®‰è£… k3s çš„æ“ä½œåœ¨æ„å»º OVA çš„æ—¶å€™å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰‹åŠ¨æ‰§è¡Œå®‰è£…è„šæœ¬æ¥å®‰è£…ã€‚</p>
<p>åªè¦å¼€æœºè¿è¡Œè™šæ‹Ÿæœºèƒ½å¤Ÿé€šè¿‡ DHCP åˆ†é…åˆ°ä¸€ä¸ªå†…ç½‘ IPv4 åœ°å€æˆ–è€…æ‰‹åŠ¨é…ç½®ä¸€ä¸ªé™æ€ IPï¼Œk3s å°±èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œèƒ½å¤ŸçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ï¼Œè€Œä¸æ˜¯åƒ kubekeyã€sealosã€kubespray é‚£æ ·å‚»ä¹ä¹åœ°å¡«å†™ä¸€ä¸ªå¤æ‚æ— æ¯”çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œä¸€äº›å‘½ä»¤æ¥å®‰è£… k8s é›†ç¾¤ã€‚è¿™ç§å¯¼å…¥è™šæ‹Ÿæœºå¼€å³ç”¨çš„æ–¹å¼ï¼Œå¯¹ç”¨æˆ·æ¥è®²ååˆ†å‹å¥½ã€‚</p>
<p>å½“ç„¶åœ¨ä½¿ç”¨ kubekeyã€sealosã€kubespray åœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å®‰è£…å¥½ k8s é›†ç¾¤ä¹Ÿä¸æ˜¯ä¸å¯è¡Œï¼Œåªä¸è¿‡æˆ‘ä»¬æ„å»ºæ—¶å€™è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 10.172.20.223ï¼‰å’Œä½¿ç”¨æ—¶çš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 192.168.20.11ï¼‰åŸºæœ¬ä¸Šæ˜¯ä¸ä¼šç›¸åŒçš„ã€‚ç»™ k8s control plain èŠ‚ç‚¹æ›´æ¢ IP çš„æ“ä½œ <a target="_blank" rel="noopener" href="https://www.qikqiak.com/">é˜³æ˜åšä¸»</a> æ›¾åœ¨ <a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/how-to-change-k8s-node-ip/">å¦‚ä½•ä¿®æ”¹ Kubernetes èŠ‚ç‚¹ IP åœ°å€?</a> æ–‡ç« ä¸­åˆ†äº«è¿‡ä»–çš„ç»å†ï¼Œçœ‹å®Œåç›´æ¥æŠŠæˆ‘æ•´ä¸ä¼šäº†ï¼Œæ„Ÿè§‰æ“ä½œèµ·æ¥å®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œè¿˜ä¸å¦‚é‡æ–°éƒ¨ç½²ä¸€å¥—æ–°çš„ k8s æ–¹ä¾¿å‘¢ ğŸ˜‚</p>
<p>å…¶å®æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ—¶å€™å®‰è£… k8s çš„æ€è·¯æœ€åˆæˆ‘æ˜¯å€Ÿé‰´çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›® ğŸ˜‚ã€‚å³å°†éƒ¨ç½² k8s ä¾èµ–çš„ä¸€äº›æ–‡ä»¶å’Œå®¹å™¨é•œåƒæ„å»ºåœ¨è™šæ‹Ÿæœºæ¨¡ç‰ˆå½“ä¸­ï¼Œéƒ¨ç½² k8s çš„æ—¶å€™ä¸éœ€è¦å†è”ç½‘ä¸‹è½½è¿™äº›ä¾èµ–èµ„æºäº†ã€‚ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ k3s ç›´æ¥æå‰å°† k8s é›†ç¾¤éƒ¨ç½²å¥½äº†ï¼Œä¹Ÿå°±çœå»äº†è®©ç”¨æˆ·æ‰§è¡Œéƒ¨ç½²çš„æ“ä½œã€‚</p>
<p>ç»¼ä¸Šï¼Œé€‰ç”¨ k3s ä½œä¸ºè¯¥æ–¹æ¡ˆçš„ K8s åº•åº§æ— ç–‘æ˜¯æœ€ä½³çš„å•¦ï¼ˆ</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="ä½¿ç”¨æ„Ÿå—"><a href="#ä½¿ç”¨æ„Ÿå—" class="headerlink" title="ä½¿ç”¨æ„Ÿå—"></a>ä½¿ç”¨æ„Ÿå—</h3><p>ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åæ„Ÿè§‰ Packer çš„å¤æ‚åº¦å’Œä¸Šæ‰‹éš¾åº¦è¦æ¯” Docker æ„å»ºå®¹å™¨é•œåƒè¦é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ã€‚å¯èƒ½æ˜¯å› ä¸ºè™šæ‹Ÿæœºå¹¶ä¸åƒå®¹å™¨é•œåƒé‚£æ ·æœ‰ <a target="_blank" rel="noopener" href="https://opencontainers.org/">OCI</a> è¿™ç§ç»Ÿä¸€çš„æ„å»ºã€åˆ†å‘ã€è¿è¡Œå·¥ä¸šæ ‡å‡†ã€‚è™šæ‹Ÿæœºçš„åˆ›å»ºå…‹éš†ç­‰æ“ä½œä¸åº•å±‚çš„ IaaS ä¾›åº”å•†è€¦åˆçš„ååˆ†ç´§å¯†ï¼Œè¿™å°±å¯¼è‡´ä¸åŒ IaaS ä¾›åº”å•†æ¯”å¦‚ vSphereã€kvm&#x2F;qemu ä»–ä»¬ä¹‹é—´èƒ½å¤Ÿå¤ç”¨çš„é…ç½®å‚æ•°å¹¶ä¸å¤šã€‚æ¯”å¦‚ vSphere é‡Œæœ‰ datastoreã€datacenterã€resource_poolã€folder ç­‰æ¦‚å¿µï¼Œä½† kvm&#x2F;qemu ä¸­ç¼ºæ²¡æœ‰ï¼Œè¿™å°±å¯¼è‡´å¾ˆéš¾å°†å®ƒä»¬ç»Ÿä¸€æˆä¸€ä¸ªé…ç½®ã€‚</p>
<h3 id="OVA-æ ¼å¼"><a href="#OVA-æ ¼å¼" class="headerlink" title="OVA æ ¼å¼"></a>OVA æ ¼å¼</h3><p>ä½¿ç”¨ OVA è€Œä¸æ˜¯ vagrant.boxã€vmdkã€rawã€qcow2 ç­‰å…¶ä»–æ ¼å¼æ˜¯å› ä¸º OVA æ”¯æŒæ”¯æŒä¸€é”®å¯¼å…¥çš„ç‰¹æ€§ï¼Œåœ¨ Windows ä¸Šä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚æ¯•ç«Ÿ Windows ä¸Šå®‰è£… Vagrant æˆ–è€… qemu&#x2F;KVM ä¹Ÿå¤Ÿä½ æŠ˜è…¾çš„äº†ï¼Œ<a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> ä½¿ç”¨å¾—æ›´å¹¿æ³›ä¸€äº›ã€‚</p>
<p>å¦å¤– Packer å¹¶ä¸æ”¯æŒç›´æ¥å°†è™šæ‹Ÿæœºå¯¼å‡ºä¸º OVA çš„æ–¹å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹åªä¼šé€šè¿‡ vCenter çš„ API å¯¼å‡ºä¸º ovfã€‚å¦‚æœéœ€è¦ OVA æ ¼å¼ï¼Œéœ€è¦å°† OVF æ‰“åŒ…æˆ OVAã€‚åœ¨ ISSUE <a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> ä¹Ÿæœ‰äººåé¦ˆäº†æ”¯æŒ OVA å¯¼å‡ºçš„éœ€æ±‚ï¼Œä½† Packer è‡³ä»Šä»æœªæ”¯æŒã€‚å°† OVF è½¬æ¢ä¸º OVA æˆ‘æ˜¯å‚è€ƒçš„ image-builder é¡¹ç›®çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong> </a> æ¥å®Œæˆçš„ã€‚</p>
<h3 id="å®‰è£…-open-vm-tool-å¤±è´¥"><a href="#å®‰è£…-open-vm-tool-å¤±è´¥" class="headerlink" title="å®‰è£… open-vm-tool å¤±è´¥"></a>å®‰è£… open-vm-tool å¤±è´¥</h3><p>ç”±äº ISO ä¸­å¹¶ä¸åŒ…å« open-vm-tool è½¯ä»¶åŒ…ï¼Œè¿™å°±éœ€è¦åœ¨ ISO å®‰è£… OS çš„è¿‡ç¨‹ä¸­è”ç½‘å®‰è£… open-vm-toolsã€‚å¦‚æœå®‰è£…çš„æ—¶å€™ç½‘ç»œæŠ–åŠ¨äº†å°±å¯èƒ½ä¼šå¯¼è‡´ open-vm-tools å®‰è£…å¤±è´¥ã€‚open-vm-tools å®‰è£…å¤±è´¥ packer æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼Œåªèƒ½ä¸€ç›´ç­‰åˆ°è·å–è™šæ‹Ÿæœº IP è¶…æ—¶åé€€å‡ºæ‰§è¡Œã€‚ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„åŠæ³•ï¼Œåªèƒ½åœ¨ kickstart é‡Œå®‰è£… open-vm-tools çš„æ—¶å€™è¿›è¡Œé‡è¯•ç›´åˆ° open-vm-tools å®‰è£…æˆåŠŸã€‚</p>
<h3 id="å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°"><a href="#å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°" class="headerlink" title="å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°"></a>å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°</h3><p>æ›¾ç»åœ¨ <a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡æ¿</a> æ–‡ç« ä¸­åˆ†æè¿‡é€šè¿‡ dd ç½®é›¶çš„æ–¹å¼å¯ä»¥å¤§å¹…å‡å°‘è™šæ‹Ÿæœºå¯¼å‡ºåçš„ vmdk æ–‡ä»¶å¤§</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">464M Aug 28 16:15 Ubuntu1804-2.ova <span class="comment"># ç½®é›¶åçš„å¤§å°</span></span><br><span class="line">1.3G Aug 28 15:48 Ubuntu1804.ova   <span class="comment"># ç½®é›¶å‰çš„å¤§å°</span></span><br></pre></td></tr></table></figure></blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ dd ç½®é›¶ä¹‹å‰è¦å…ˆåœæ­¢ k3s æœåŠ¡ï¼Œä¸ç„¶ç½®é›¶çš„æ—¶å€™ä¼šå æ»¡ root æ ¹åˆ†åŒºå¯¼è‡´ kubelet å¯åŠ¨ GC å°†ä¸€äº›é•œåƒç»™åˆ é™¤æ‰ã€‚ä¹‹å‰å¯¼å‡ºè™šæ‹Ÿæœºåå‘ç°å°‘äº†ä¸€äº›é•œåƒï¼Œæ’æŸ¥äº†å¥½ä¹…æ‰å‘ç°æ˜¯ kubelet GC æŠŠæˆ‘çš„é•œåƒç»™åˆ æ‰äº†ï¼Œè¸©äº†ä¸ªå¤§å‘ï¼Œå¯æ°”æ­»æˆ‘äº† ğŸ˜¡</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ containerd ä¸­ <code>io.containerd.content.v1.content/blobs/sha256</code> ä¸€äº›é•œåƒ layer çš„åŸå§‹ blob æ–‡ä»¶æ˜¯ä¸éœ€è¦çš„ï¼Œå¯ä»¥å°†å®ƒä»¬ç»™åˆ é™¤æ‰ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘éƒ¨åˆ†ç£ç›˜ç©ºé—´å ç”¨ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>()&#123;</span><br><span class="line">  <span class="comment"># stop k3s server for for prevent it starting the garbage collection to delete images</span></span><br><span class="line">  systemctl stop k3s</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Ensure on next boot that network devices get assigned unique IDs.</span></span><br><span class="line">  sed -i <span class="string">&#x27;/^\(HWADDR\|UUID\)=/d&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-* 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Clean up network interface persistence</span></span><br><span class="line">  find /var/log -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">truncate</span> --size=0 &#123;&#125; \;</span><br><span class="line">  <span class="built_in">rm</span> -rf /tmp/* /var/tmp/*</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cleanup all blob files of registry download image</span></span><br><span class="line">  find /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 -size +1M -<span class="built_in">type</span> f -delete</span><br><span class="line"></span><br><span class="line">  <span class="comment"># zero out the rest of the free space using dd, then delete the written file.</span></span><br><span class="line">  <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/EMPTY bs=4M status=progress || <span class="built_in">rm</span> -f /EMPTY</span><br><span class="line">  <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/data/EMPTY bs=4M status=progress || <span class="built_in">rm</span> -f /data/EMPTY</span><br><span class="line">  <span class="comment"># run sync so Packer doesn&#x27;t quit too early, before the large file is deleted.</span></span><br><span class="line">  <span class="built_in">sync</span></span><br><span class="line"></span><br><span class="line">  yum clean all</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Photon3"><a href="#Photon3" class="headerlink" title="Photon3"></a>Photon3</h3><p>ä¹‹å‰åœ¨ <a href="https://blog.k8s.li/Photon-OS.html">è½»é‡çº§å®¹å™¨ä¼˜åŒ–å‹ Linux å‘è¡Œç‰ˆ Photon OS</a> é‡Œåˆ†äº«è¿‡ VMware çš„ Linux å‘è¡Œç‰ˆ <a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>ã€‚ä¸åŒäºä¼ ç»Ÿçš„ Linux å‘è¡Œç‰ˆ Photon çš„ç³»ç»Ÿååˆ†ç²¾ç®€ï¼Œä½¿ç”¨å®ƒæ›¿ä»£ CentOS èƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šå‡å°‘ç³»ç»Ÿèµ„æºçš„å ç”¨ï¼Œå¯¼å‡ºåçš„ vmdk æ–‡ä»¶ä¹Ÿè¦æ¯” CentOS å°ä¸€äº›ã€‚</p>
<h3 id="goss"><a href="#goss" class="headerlink" title="goss"></a><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a></h3><p>åœ¨æ„å»ºçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬åœ¨ k3s é›†ç¾¤ä¸Šå®‰è£…äº†ä¸€äº›å…¶ä»–çš„ç»„ä»¶ï¼Œæ¯”å¦‚æä¾›æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½æœåŠ¡çš„ filebrowser ä»¥åŠ workflow å·¥ä½œæµå¼•æ“ argo-workflowï¼Œä¸ºäº†ä¿è¯è¿™äº›æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¸åŒçš„æ–¹å¼å»æ£€æŸ¥è¿™äº›æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡ kubectl get ç­‰å‘½ä»¤æŸ¥çœ‹ deploymentã€podã€daemonset ç­‰æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–è€…é€šè¿‡ curl è®¿é—®è¿™äº›è¿™äº›æœåŠ¡çš„å¥åº·æ£€æŸ¥ APIã€‚</p>
<p>ç”±äºæ£€æŸ¥é¡¹æ¯”è¾ƒå¤šä¸”ååˆ†ç¹çï¼Œä½¿ç”¨ä¼ ç»Ÿçš„ shell è„šæœ¬æ¥åšè¿™å¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œéœ€è¦è§£ææ¯ä¸ªå‘½ä»¤çš„é€€å‡ºç ä»¥åŠè¿”å›å€¼ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a> é€šè¿‡ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥å®šä¹‰ä¸€äº›æ£€æŸ¥é¡¹ï¼Œè®©å®ƒæ‰¹é‡æ¥æ‰§è¡Œè¿™äº›æ£€æŸ¥ï¼Œè€Œä¸ç”¨åœ¨ shell å¯¹æ¯ä¸ªæ£€æŸ¥é¡¹å†™ä¸€å †çš„ awk&#x2F;grep ç­‰å‘½ä»¤æ¥ check äº†ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>ï¼šç”¨äºæ£€æŸ¥ k3s ä»¥åŠå®ƒé»˜è®¤è‡ªå¸¦çš„æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># DNS ç±»å‹çš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ coredns æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æåˆ° kubernetes apiserver çš„ service IP åœ°å€</span></span><br><span class="line">  <span class="attr">kubernetes.default.svc.cluster.local:</span></span><br><span class="line">    <span class="attr">resolvable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">addrs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.43</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.43</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP/UDP ç«¯å£ç±»å‹çš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">addr:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ coredns çš„ UDP 53 ç«¯å£æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">udp://10.43.0.10:53:</span></span><br><span class="line">    <span class="attr">reachable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ cni0 ç½‘æ¡¥æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="attr">interface:</span></span><br><span class="line">  <span class="attr">cni0:</span></span><br><span class="line">    <span class="attr">exists:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">addrs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.42</span><span class="number">.0</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬æœºç«¯å£ç±»å‹çš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">port:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ ssh 22 ç«¯å£æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">tcp:22:</span></span><br><span class="line">    <span class="attr">listening:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ip:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ kubernetes apiserver 6443 ç«¯å£æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">tcp6:6443:</span></span><br><span class="line">    <span class="attr">listening:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ä¸€äº› systemd æœåŠ¡çš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="comment"># é»˜è®¤ç¦ç”¨ firewalld æœåŠ¡</span></span><br><span class="line">  <span class="attr">firewalld:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">running:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># ç¡®ä¿ sshd æœåŠ¡æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">  <span class="attr">sshd:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">running:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ k3s æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">  <span class="attr">k3s:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">running:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€äº› shell å‘½ä»¤æ‰§è¡Œçš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ kubernetes cheduler ç»„ä»¶æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_k8s_scheduler_health:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">curl</span> <span class="string">-k</span> <span class="string">https://127.0.0.1:10259/healthz</span></span><br><span class="line">    <span class="comment"># é€€å‡ºç æ˜¯å¦ä¸º 0</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="comment"># æ ‡å‡†è¾“å‡ºä¸­æ˜¯å¦åŒ…å«æ­£ç¡®çš„è¾“å‡ºå€¼</span></span><br><span class="line">    <span class="attr">stdout:</span> [<span class="string">&quot;ok&quot;</span>]</span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ kubernetes controller-manager æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_k8s_controller-manager_health:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">curl</span> <span class="string">-k</span> <span class="string">https://127.0.0.1:10257/healthz</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">stdout:</span> [<span class="string">&quot;ok&quot;</span>]</span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ cluster-info  ä¸­è¾“å‡ºçš„ç»„ä»¶è¿è¡ŒçŠ¶æ€æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_cluster_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">cluster-info</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&#x27;is running&#x27;</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CoreDNS</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Kubernetes</span> <span class="string">control</span> <span class="string">plane</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¤„äº Ready çŠ¶æ€</span></span><br><span class="line">  <span class="attr">check_node_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">jsonpath=&#x27;&#123;.items[].status&#125;&#x27;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.conditions[-1].type&#x27;</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Ready</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥èŠ‚ç‚¹ IP æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">  <span class="attr">check_node_address:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.items[0].status.addresses[] | select(.type == &quot;InternalIP&quot;) | .address&#x27;</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;&#123; <span class="string">.Vars.ip_address</span> &#125;&#125;</span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ traefik loadBalancer çš„ IP åœ°å€æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">  <span class="attr">check_traefik_address:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">traefik</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.status.loadBalancer.ingress[].ip&#x27;</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;&#123; <span class="string">.Vars.ip_address</span> &#125;&#125;</span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ containerd å®¹å™¨è¿è¡Œæ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_container_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">crictl</span> <span class="string">ps</span> <span class="string">--output=json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.containers[].metadata.name&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coredns</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/lb-.*-443/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/lb-.*-80/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ kube-system namespace ä¸‹çš„ pod æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_kube_system_namespace_pod_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.items[] | select((.status.phase != &quot;Running&quot;) and (.status.phase != &quot;Succeeded&quot;) and (.status.phase != &quot;Completed&quot;))&#x27;</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span> [<span class="string">&quot;!string&quot;</span>]</span><br><span class="line">  <span class="comment"># æ£€æŸ¥ k8s deployment æœåŠ¡æ˜¯å¦éƒ½æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_k8s_deployment_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">--all-namespaces</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coredns</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ svclb-traefik daemonset æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_k8s_daemonset_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">daemonset</span> <span class="string">--all-namespaces</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">svclb-traefik</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>ï¼šç”¨äºæ£€æŸ¥æˆ‘ä»¬éƒ¨ç½²çš„ä¸€äº›æœåŠ¡æ˜¯å¦æ­£å¸¸</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ include å…¶ä»– gossfile æ–¹å¼å°†ä¸Šé¢å®šä¹‰çš„ k3s.yaml æ£€æŸ¥é¡¹ä¹ŸåŒ…å«è¿›æ¥</span></span><br><span class="line"><span class="attr">gossfile:</span></span><br><span class="line">  <span class="attr">k3s.yaml:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥éƒ¨ç½²çš„ filebrowser deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span></span><br><span class="line">  <span class="attr">filebrowser.default.svc.cluster.local:</span></span><br><span class="line">    <span class="attr">resolvable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.43</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥éƒ¨ç½²çš„ argo-workflow deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span></span><br><span class="line">  <span class="attr">argo-workflow-argo-workflows-server.default.svc.cluster.local:</span></span><br><span class="line">    <span class="attr">resolvable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.43</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº› HTTP è¯·æ±‚æ–¹å¼çš„æ£€æŸ¥</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ filebrowser æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç±»ä¼¼äº pod é‡Œçš„å­˜æ´»æ¢é’ˆ</span></span><br><span class="line">  <span class="string">http://&#123;&#123;</span> <span class="string">.Vars.ip_address</span> <span class="string">&#125;&#125;/filebrowser/:</span></span><br><span class="line">    <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ argo-workflow æ˜¯å¦æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">  <span class="string">http://&#123;&#123;</span> <span class="string">.Vars.ip_address</span> <span class="string">&#125;&#125;/workflows/api/v1/version:</span></span><br><span class="line">    <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ ·ä¹Ÿæ˜¯ä¸€äº› shell å‘½ä»¤çš„æ£€æŸ¥é¡¹ç›®</span></span><br><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥å®¹å™¨é•œåƒæ˜¯å¦é½å…¨ï¼Œé¿å…ç¼ºé•œåƒçš„é—®é¢˜</span></span><br><span class="line">  <span class="attr">check_container_images:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">crictl</span> <span class="string">images</span> <span class="string">--output=json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.images[].repoTags[]&#x27;</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">-F</span> <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">-F</span> <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">argocli</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">argoexec</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">workflow-controller</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">filebrowser</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥å®¹å™¨è¿è¡Œçš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_container_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">crictl</span> <span class="string">ps</span> <span class="string">--output=json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.containers[].metadata.name&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">argo-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">controller</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># æ£€æŸ¥ä¸€äº› deployment çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="attr">check_k8s_deployment_status:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-n</span> <span class="string">default</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">&#x27;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#x27;</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-u</span></span><br><span class="line">    <span class="attr">exit-status:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stderr:</span> []</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stdout:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">argo-workflow-argo-workflows-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">argo-workflow-argo-workflows-workflow-controller</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">skip:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›ç¡¬ä»¶å‚æ•°çš„æ£€æŸ¥ï¼Œæ¯”å¦‚ CPU æ ¸å¿ƒæ•°ã€å†…å­˜å¤§å°ã€å¯ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">matching:</span></span><br><span class="line">  <span class="attr">check_vm_cpu_core:</span></span><br><span class="line">    <span class="attr">content:</span> &#123;&#123; <span class="string">.Vars.cpu_core_number</span> &#125;&#125;</span><br><span class="line">    <span class="attr">matches:</span></span><br><span class="line">      <span class="attr">gt:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">check_vm_memory_size:</span></span><br><span class="line">    <span class="attr">content:</span> &#123;&#123; <span class="string">.Vars.memory_size</span> &#125;&#125;</span><br><span class="line">    <span class="attr">matches:</span></span><br><span class="line">      <span class="attr">gt:</span> <span class="number">1880000</span></span><br><span class="line">  <span class="attr">check_available_memory_size:</span></span><br><span class="line">    <span class="attr">content:</span> &#123;&#123; <span class="string">.Vars.available_memory_size</span> &#125;&#125;</span><br><span class="line">    <span class="attr">matches:</span></span><br><span class="line">      <span class="attr">gt:</span> <span class="number">600000</span></span><br></pre></td></tr></table></figure>

<p>å¦å¤– goss ä¹Ÿæ¯”è¾ƒé€‚åˆåšä¸€äº›å·¡æ£€çš„å·¥ä½œã€‚æ¯”å¦‚åœ¨ä¸€ä¸ª k8s é›†ç¾¤ä¸­è¿›è¡Œå·¡æ£€ï¼šæ£€æŸ¥é›†ç¾¤å†… pod çš„çŠ¶æ€ã€kubernetes ç»„ä»¶çš„çŠ¶æ€ã€CNI è¿è¡ŒçŠ¶æ€ã€èŠ‚ç‚¹çš„ç½‘ç»œã€ç£ç›˜å­˜å‚¨ç©ºé—´ã€CPU è´Ÿè½½ã€å†…æ ¸å‚æ•°ã€daemonset æœåŠ¡çŠ¶æ€ç­‰ï¼Œéƒ½å¯ä»¥å‚ç…§ä¸Šè¿°æ–¹å¼å®šä¹‰ä¸€ç³»åˆ—çš„æ£€æŸ¥é¡¹ï¼Œä½¿ç”¨ goss æ¥å¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆå·¡æ£€ã€‚</p>
<h3 id="å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸"><a href="#å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸" class="headerlink" title="å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸"></a>å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸</h3><p>å°† OVA è™šæ‹Ÿæœºåœ¨ VMware Workstation ä¸Šå¯¼å…¥ä¹‹åï¼Œç”±äºè™šæ‹Ÿæœº IP çš„å˜åŒ–å¯èƒ½ä¼šå¯¼è‡´ä¸€äº› Pod å¤„äºå¼‚å¸¸çš„çŠ¶æ€ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¯¹è¿™äº› Pod è¿›è¡Œå¼ºåˆ¶åˆ é™¤ï¼Œå¼ºåˆ¶é‡å¯ä¸€ä¸‹æ‰èƒ½æ¢å¤æ­£å¸¸ã€‚å› æ­¤éœ€è¦éœ€è¦åœ¨è™šæ‹Ÿæœºé‡Œå¢åŠ ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> è„šæœ¬ç”¨æ¥é‡å¯è¿™äº›çŠ¶æ€å¼‚å¸¸çš„ Podã€‚å½“å¯¼å…¥ OVA è™šæ‹Ÿæœºåè¿è¡Œè¿™ä¸ªè„šæœ¬è®©æ‰€æœ‰çš„ Pod éƒ½æ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œç„¶åå†è°ƒç”¨ goss æ¥æ£€æŸ¥å…¶ä»–æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line">kubectl get pods --no-headers -n kube-system | grep -E <span class="string">&#x27;0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff&#x27;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs -t -I &#123;&#125; kubectl delete pod -n kube-system --grace-period=0 --force &#123;&#125; &gt; /dev/null  2&gt;&amp;1 || <span class="literal">true</span></span><br><span class="line">kubectl get pods --no-headers -n default | grep -E <span class="string">&#x27;0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff&#x27;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs -t -I &#123;&#125; kubectl delete pod -n default --grace-period=0 --force &#123;&#125; &gt; /dev/null  2&gt;&amp;1 || <span class="literal">true</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> kubectl get pods --no-headers --all-namespaces | grep -Ev <span class="string">&#x27;Running|Completed&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Waiting for service readiness&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;HOME&#125;</span>/.goss</span><br><span class="line"><span class="built_in">cat</span> &gt; vars.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">ip_address: $(ip r get 1 | sed &quot;s/ uid.*//g&quot; | awk &#x27;&#123;print $NF&#125;&#x27; | head -n1)</span></span><br><span class="line"><span class="string">cpu_core_number: $(grep -c ^processor /proc/cpuinfo)</span></span><br><span class="line"><span class="string">memory_size: $(grep &#x27;^MemTotal:&#x27; /proc/meminfo | awk &#x27;&#123;print $2&#125;&#x27;)</span></span><br><span class="line"><span class="string">available_memory_size: $(grep &#x27;^MemAvailable:&#x27; /proc/meminfo | awk &#x27;&#123;print $2&#125;&#x27;)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">goss --vars vars.yaml -g goss.yaml validate --retry-timeout=10s</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/754ba85c.html">K3S å·¥å…·è¿›é˜¶å®Œå…¨æŒ‡å—</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss/blob/master/docs/manual.md">goss</a>ï¼šgoss é…ç½®æ–‡æ¡£</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alexellis/awesome-baremetal">awesome-baremetal</a>ï¼šä¸€äº›ä¸è£¸é‡‘å±æœåŠ¡å™¨ç›¸å…³çš„å·¥å…·æ±‡æ€»</li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a>ï¼šCentOS&#x2F;Red Hat kickstart è¯­æ³•</li>
<li><a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/photon_user/kickstart.html">Kickstart Support in Photon OS</a>ï¼šPhoton OS çš„ kickstart è¯­æ³•</li>
</ul>
<h3 id="Packer-ç›¸å…³"><a href="#Packer-ç›¸å…³" class="headerlink" title="Packer ç›¸å…³"></a>Packer ç›¸å…³</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/chef/bento">bento</a>ï¼šæ˜¯ä¸€ä¸ª Packer æœ€ä½³å®è·µçš„æ¨¡ç‰ˆä»“åº“ï¼Œä¸è¿‡å®ƒçš„ builder æ˜¯ Vagrantï¼Œä½†å¯ä»¥ä»ä¸­å€Ÿé‰´ä¸€äº› Linux å‘è¡Œç‰ˆçš„è‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬ï¼Œæ¯”å¦‚ CentOS çš„ <a target="_blank" rel="noopener" href="https://github.com/chef/bento/tree/main/packer_templates/centos/http">kickstart</a> æ–‡ä»¶ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FnnMnu9i6gFNrAjIlzaNnQ">åŸºäº Packer+Ansible å®ç°äº‘å¹³å°é»„é‡‘é•œåƒç»Ÿä¸€æ„å»ºå’Œå‘å¸ƒ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi">Image Builder for Cluster API</a></li>
<li><a target="_blank" rel="noopener" href="https://image-builder.sigs.k8s.io/capi/providers/vsphere.html#building-images-for-vsphere">Building Images for vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-clone">VMware vSphere Clone Builder</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso">Packer Builder for VMware vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer-plugin-vsphere">packer-plugin-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-samples/packer-examples-for-vsphere">packer-examples-for-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rockylinux.org/guides/automation/templates-automation-packer-vsphere/">Automatic template creation with Packer and deployment with Ansible in a VMware vSphere environment</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/packer/" rel="tag"># packer</a>
              <a href="/tags/esxi/" rel="tag"># esxi</a>
              <a href="/tags/k3s/" rel="tag"># k3s</a>
              <a href="/tags/vSphere/" rel="tag"># vSphere</a>
              <a href="/tags/argo-workflow/" rel="tag"># argo-workflow</a>
              <a href="/tags/redfish/" rel="tag"># redfish</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021-08-25-build-k8s-binary-by-github-actions.html" rel="prev" title="ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶">
                  <i class="fa fa-chevron-left"></i> ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023-04-15-One-Year-After-the-Lockdown-in-Shanghai.html" rel="next" title="å†™åœ¨ä¸Šæµ·å°åŸä¸€å¹´ä¹‹å">
                  å†™åœ¨ä¸Šæµ·å°åŸä¸€å¹´ä¹‹å <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script>
<script src="/js/comments.js" defer></script><script src="/js/utils.js" defer></script><script src="/js/next-boot.js" defer></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/pace.js" defer></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
